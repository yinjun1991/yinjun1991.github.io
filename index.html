<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>写好代码</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="写好代码">
<meta property="og:url" content="http://yinjun.github.io/index.html">
<meta property="og:site_name" content="写好代码">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yinjun">
<meta property="article:tag" content="yinjun">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="写好代码" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">写好代码</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一个平庸程序员的博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yinjun.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-articles" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/articles/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:34:05.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/articles/">好文集锦</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/260068315">架构制图：工具与方法论</a></li>
<li><a target="_blank" rel="noopener" href="https://www.infoq.com/articles/crafting-architectural-diagrams/">The Art of Crafting Architectural Diagrams</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/articles/" data-id="cl2ef05l100008mmtgblt0bvv" data-title="好文集锦" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-chrome_extension" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/chrome_extension/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:34:05.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/chrome_extension/">chrome 插件开发入门</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>丰富的 chrome 插件极大的提升我们的工作效率和辛福感，比如大名鼎鼎的 adblock 广告屏蔽、GoFullPage 网页长截图、evernote web clipper 收藏网页。</p>
<p>一般来说，插件的原理是向页面中注入 javascript 脚本，对页面进行处理，比如屏蔽页面中可能的广告元素，改变某些元素的样式，增加一些 UI。</p>
<p>开发插件需要使用前端技术：html css javascript。</p>
<p>本文就从入门开始讲述如何开发一款 chrome 插件。</p>
<p>注意：chrome 插件机制本身也在更新，本文讲述的是目前普遍使用的 V2 插件的开发。</p>
<p>Manifest V3 is available beginning with Chrome 88, and the Chrome Web Store begins accepting MV3 extensions in January 2021.</p>
<h2 id="插件构成"><a href="#插件构成" class="headerlink" title="插件构成"></a>插件构成</h2><p>chrome 插件通常由以下几部分组成：</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/extensions/mv2/getstarted/">manifest.json</a>：相当于插件的 meta 信息，包含插件的名称、版本号、图标、脚本文件名称等，这个文件是每个插件都必须提供的，其他几部分都是可选的。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/extensions/mv2/background_pages/">background script</a>：可以调用全部的 chrome 插件 API，实现跨域请求、网页截屏、弹出 chrome 通知消息等功能。相当于在一个隐藏的浏览器页面内默默运行。</p>
</li>
<li><p>功能页面：包括点击插件图标弹出的页面（简称 popup）、插件的配置页面（简称 options）。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/extensions/mv2/content_scripts/">content script</a>：早期也被称为 injected script，是插件注入到页面的脚本，但是不会体现在页面 DOM 结构里。content script 可以操作 DOM，但是它和页面其他的脚本是隔离的，访问不到其他脚本定义的变量、函数等，相当于运行在单独的沙盒里。content script 可以调用有限的 chrome 插件 API，网络请求收到同源策略限制。</p>
</li>
</ol>
<p>插件的架构可以参考<a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/extensions/mv2/architecture-overview/">官方文档</a>。</p>
<p>重点说明以下几点：</p>
<ol>
<li>browser action 和 page action：这俩我们可以理解为插件的按钮。browser action 会固定在 chrome 的工具栏。而 page action 可以设置特定的网页才显示图标，在地址栏的右端，如下图：</li>
</ol>
<p><img src="/images/chrome_extension/actions.png" alt="actions.png"></p>
<p>大部分插件点击之后会显示 UI，也就是上文描述的插件功能页面部分，一般称为 popup 页面，如下图：</p>
<p><img src="/images/chrome_extension/popup.png" alt="popup.png"></p>
<p><strong>popup 无法通过程序打开，只能由用户点击打开。点击 popup 之外的区域会导致 popup 收起。</strong></p>
<p>page action 和 browser action 分别由 manifest.json 的 <a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/extensions/reference/pageAction/">page_action</a> 和 <a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/extensions/reference/browserAction/">browser_action</a> 字段配置。</p>
<ol start="2">
<li><p>由于 content script 受到同源策略的限制，所以一般网络请求都交给 background script 处理。</p>
</li>
<li><p>content script、插件功能页面、background script 之间的通信架构如下图：</p>
</li>
</ol>
<p><img src="/images/chrome_extension/communication.avif" alt="插件通信"></p>
<ol start="4">
<li>chrome 可以打开多个浏览器窗口，而一个窗口会有多个 tab，所以插件的结构大致如下：</li>
</ol>
<p><img src="/images/chrome_extension/tabs.png" alt="tabs.png"></p>
<p>如上图，功能页面是每个 window 一份，但是每个 tab 都会注入 content script。</p>
<h2 id="manifest-json"><a href="#manifest-json" class="headerlink" title="manifest.json"></a>manifest.json</h2><p>下文简称 manifest ，其中有这么几个字段可以重点说明：</p>
<h3 id="content-scripts"><a href="#content-scripts" class="headerlink" title="content_scripts"></a>content_scripts</h3><p>content_scripts 可以使用以下两种方式注入页面，这两种方式并不冲突，可以结合使用。</p>
<h4 id="声明式注入"><a href="#声明式注入" class="headerlink" title="声明式注入"></a>声明式注入</h4><p>举例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;content_scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;matches&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http://*/*&quot;</span><span class="punctuation">,</span> <span class="string">&quot;https://*/*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;run_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;document_idle&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;js&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;content.js&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在 manifest 中声明要加载的脚本，各个字段都比较直观。其中：</p>
<ol>
<li>matches 表示页面 url 匹配时才加载</li>
<li><code>run_at</code> 表示在什么时机加载，一般是 <code>document_idle</code>，避免 content_scripts 影响页面加载性能。</li>
</ol>
<p>需要注意的是，如果用户已经打开了 N 个页面，然后再安装插件，这 N 个页面除非重新刷新，否则是不会加载 manifest 声明的 content_scripts。安装插件之后新打开的页面是可以加载 content_scripts 的。</p>
<p>所以需要在用户点击插件图标时，探测页面中的 content_scripts 是否存在（发送消息是否有响应&#x2F;出错），再提示用户刷新页面。</p>
<h4 id="程序注入"><a href="#程序注入" class="headerlink" title="程序注入"></a>程序注入</h4><p>还可以使用程序动态注入脚本，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chrome.<span class="property">tabs</span>.<span class="title function_">executeScript</span>(&#123;</span><br><span class="line">  <span class="attr">file</span>: <span class="string">&#x27;content.js&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>比如用户点击插件图标时执行注入脚本，则无需刷新页面，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 监听插件图标点击事件</span><br><span class="line">chrome.browserAction.onClicked.addListener(() =&gt; &#123;</span><br><span class="line">  chrome.tabs.executeScript(&#123;</span><br><span class="line">    file: &#x27;content.js&#x27;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>值得注意的是，采用以上方式，用户每次点击插件图标时，content.js 都会被执行，可能会引起错误。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content.js</span></span><br><span class="line"><span class="keyword">let</span> loaded = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!loaded) &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">  loaded = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(loaded);</span><br></pre></td></tr></table></figure>

<p>第一次执行 content.js 会打印 false，而第二次执行 content.js 则会报错，提示 loaded 变量已经声明了。</p>
<p>由此可见 content.js 的执行会影响其所在的沙盒。</p>
<p>我们可以这么做：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">contentLoaded</span>) &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">contentLoaded</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span>.<span class="property">contentLoaded</span>);</span><br></pre></td></tr></table></figure>

<p>使用沙盒内的全局变量则可以避免 content.js 重复执行带来的问题。</p>
<p>综上所述：声明式只会注入一次，缺点是可能需要刷新页面。程序式不需要刷新页面，缺点是可能会注入多次。</p>
<h3 id="permissions"><a href="#permissions" class="headerlink" title="permissions"></a>permissions</h3><p>该字段是一个字符串数组，用来声明插件需要的权限，这样才能调用某些 chrome API，常见的有：</p>
<ol>
<li>tabs</li>
<li>activeTab</li>
<li>contextMenus：网页右键菜单，browser_action 右键菜单</li>
<li>cookies：操作 cookie，和用户登录态相关的功能可能会用到该权限</li>
<li>storage：插件存储，不是 localStorage</li>
<li>web_accessible_resources：网页能访问的插件内部资源，比如插件提供 SDK 给页面使用，如 ethereum 的 metamask 钱包插件。或者是修改 DOM 结构用到了插件的样式、图片、字体等资源。</li>
</ol>
<p>permissions 中还可以声明多个 url patterns，表示插件需要访问这些 url，比如和 API 通信。</p>
<h2 id="background-script"><a href="#background-script" class="headerlink" title="background script"></a>background script</h2><p>下文简称 background，可以理解它是在一个隐藏的 tab 中执行，所在的页面域名为空，这会影响对 document.cookie 的使用。</p>
<p>比如 background 需要和 a.com 通信。首先应该把 <code>*://*.a.com/*</code> 加入到 manifest 的 permissions 数组中。</p>
<p>当发送网络请求时，浏览器会自动带上 a.com 的 cookie，服务器的 set-cookie 也会对浏览器生效。这是符合预期的。</p>
<p>但是读取 document.cookie 时，由于 background 所在的域名为空，a.com 被认为是第三方 cookie，会读取不到。所以需要使用 <a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/extensions/reference/cookies/">chrome.cookies</a> API 来读取 cookie。</p>
<p>background 设置 document.cookie 时，<strong>不能指定域名</strong>，否则会设置失败。比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 会失败，因为指定的域名和 background 所在的域名不符</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">`session=xxxxxxx; domain=a.com; max-age=9999999999; path=/`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确的做法，不要指定域名</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">`session=xxxxxxx; max-age=9999999999`</span>;</span><br></pre></td></tr></table></figure>

<p>一般不需要这么操作 cookie，但是可能依赖的 npm 包会操作 document.cookie，所以这里说明一下。</p>
<p>background 使用 tabs 接口操作浏览器的 tab 窗口，比如：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打开新 tab</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">open</span>(<span class="params">url: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    chrome.<span class="property">tabs</span>.<span class="title function_">create</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        url</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function">(<span class="params">tab</span>) =&gt;</span> <span class="title function_">resolve</span>(tab.<span class="property">id</span>!)</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取活跃的 tab，通常是用户正在浏览的页面</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getActiveTab</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;chrome.<span class="property">tabs</span>.<span class="property">Tab</span> | <span class="literal">null</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    chrome.<span class="property">tabs</span>.<span class="title function_">query</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">active</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">currentWindow</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function">(<span class="params">tabs</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tabs.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(tabs[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将指定的 tab 变成活跃的</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">activate</span>(<span class="params"></span></span><br><span class="line"><span class="params">  tabId?: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  url?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span> | <span class="literal">undefined</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tabId === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> tabId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// firefox 不支持 selected 参数</span></span><br><span class="line">  <span class="comment">// https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update#parameters</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">options</span>: chrome.<span class="property">tabs</span>.<span class="property">UpdateProperties</span> = <span class="variable constant_">IS_FIREFOX</span></span><br><span class="line">    ? &#123; <span class="attr">active</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    : &#123; <span class="attr">selected</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">  <span class="keyword">if</span> (url) &#123;</span><br><span class="line">    options.<span class="property">url</span> = url;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    chrome.<span class="property">tabs</span>.<span class="title function_">update</span>(tabId, options, <span class="function">() =&gt;</span> <span class="title function_">resolve</span>(tabId));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开新窗口，或者是激活窗口</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">openOrActivate</span>(<span class="params">url: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> pattern = <span class="title function_">getUrlPattern</span>(url);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt;(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    chrome.<span class="property">tabs</span>.<span class="title function_">query</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">url</span>: pattern</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function">(<span class="params">tabs</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tabs.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; tabs[<span class="number">0</span>].<span class="property">id</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Tabs</span>.<span class="title function_">activate</span>(tabs[<span class="number">0</span>].<span class="property">id</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">open</span>(url).<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> <span class="title function_">resolve</span>(id));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="content-scripts-1"><a href="#content-scripts-1" class="headerlink" title="content scripts"></a>content scripts</h2><p>下文简称 <a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/extensions/mv2/content_scripts/">content</a>，它只能使用有限的 chrome API。</p>
<p>由于 content 可以访问 DOM，可以用它来选择、修改、删除、增加网页元素。</p>
<p>但是 content 是运行在隔离的空间（类似沙盒），所以如果需要和页面的其他脚本通信，需要采用 <code>window.postMessage</code> 的方式。</p>
<p>比如页面内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span>&gt;</span>submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="property">globalData</span> = &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">userId</span>: <span class="number">12345</span></span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>content 内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 成功</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">&#x27;hello chrome&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// window.globalData 是 undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span>.<span class="property">globalData</span>);</span><br></pre></td></tr></table></figure>

<h3 id="资源注入"><a href="#资源注入" class="headerlink" title="资源注入"></a>资源注入</h3><p>content 可以向页面中注入 <code>&lt;script&gt;</code>，由此给页面提供 SDK 等功能，注入的脚本和页面自己的脚本一样，都无法和 content 直接通信。</p>
<p>注意：注入的资源要先在 menifest 的 <code>web_accessible_resources</code> 字段中声明。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content 内容</span></span><br><span class="line"><span class="keyword">const</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">script.<span class="property">src</span> = chrome.<span class="property">runtime</span>.<span class="title function_">getURL</span>(<span class="string">&#x27;sdk.js&#x27;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(script);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sdk.js</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">jsbridge</span> = &#123;</span><br><span class="line">  <span class="attr">version</span>: <span class="string">&#x27;1.0.1&#x27;</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>content 执行之后，可以看到页面结构多了个 <code>&lt;script src=&quot;chrome-extension://xxxxxxxxxxxxx/sdk.js&quot;&gt;&lt;/script&gt;</code>，xxxxxxxx 表示插件的 id，由 chrome 生成。</p>
<p>注意，注入的 sdk.js 脚本是可以被页面内其他脚本访问到的（可以看作是页面自己的脚本，只是 origin 是 chrome-extensions:&#x2F;&#x2F;xxxxxxxxxxxxx），如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;btn&#x27;</span>).<span class="title function_">addEventListener</span>(</span><br><span class="line">  <span class="string">&#x27;click&#x27;</span>,</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span>.<span class="property">jsbridge</span>.<span class="property">version</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="literal">false</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="通信"><a href="#通信" class="headerlink" title="通信"></a>通信</h3><p>content 可以和 background、popup、options 使用 chrome API 通信，参考官方文档：<a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/extensions/mv2/background_pages/">https://developer.chrome.com/docs/extensions/mv2/background_pages/</a></p>
<p>常用的通信 API 是 <code>chrome.runtime.sendMessage</code>。</p>
<h3 id="UI"><a href="#UI" class="headerlink" title="UI"></a>UI</h3><p>content 可以向页面中注入 UI，比如 evernote 的剪辑插件。</p>
<p><img src="/images/chrome_extension/evernote.png" alt="evernote.png"></p>
<p>前面提到过，点击 popup 之外的区域会导致 popup 收起，操作 DOM 会导致 popup 隐藏，而 <strong>popup 无法用代码主动打开</strong>，所以 evernote 的剪辑插件的 UI 就无法用 popup 来实现了。</p>
<p>这时候可以把 UI 作为 iframe 插入页面，比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">app.<span class="property">src</span> = chrome.<span class="property">runtime</span>.<span class="title function_">getURL</span>(<span class="string">&#x27;app.html&#x27;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(app);</span><br></pre></td></tr></table></figure>

<p>神奇的是 iframe 里的 javascript 是可以像 content 一样和 background 通信的。</p>
<p>background 给 iframe 发送消息时，不仅需要指定所在 tab 的 id，还需要指定 iframe 的 id。这里说的 iframe id 类似 tab id，是 chrome 分配的，而不是 iframe 标签的 id 属性。</p>
<h2 id="功能页面"><a href="#功能页面" class="headerlink" title="功能页面"></a>功能页面</h2><p>popup&#x2F;options 和 background 的关系很亲密，它们甚至可以通过 <code>chrome.extension.getBackgroundPage()</code> 获取到 background 的全局变量。所以它们直接的通信花样很多，不过一般也是用 <code>chrome.runtime</code> 通信。</p>
<p>popup&#x2F;options 和 content 之间的通信方式，可以 background -&gt; content 通信类似。</p>
<p>options 用来设置插件，所以一般需要调用 <code>chrome.storage</code> 存储配置。</p>
<h2 id="适配其他浏览器"><a href="#适配其他浏览器" class="headerlink" title="适配其他浏览器"></a>适配其他浏览器</h2><p>目前 chrome 插件适配工作量是比较小的，因为 edge、opera 都已经切换到 chromium 内核，firefox 也支持 chrome API。</p>
<p>不过需要查看用到的 API 是否支持，以及 API 的入参、出参是否一致。<br>比如前文提到 firefox <code>chrome.tabs.update</code> 方法第一个参数不支持 selected 属性。</p>
<p>firefox 还支持 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions">browser</a> API，和 chrome API 不同的是 browser API 不使用回调函数，而是返回 promise。比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">browser.<span class="property">tabs</span>.<span class="title function_">query</span>(&#123; <span class="attr">currentWindow</span>: <span class="literal">true</span> &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(res));</span><br><span class="line"></span><br><span class="line">chrome.<span class="property">tabs</span>.<span class="title function_">query</span>(&#123; <span class="attr">currentWindow</span>: <span class="literal">true</span> &#125;, <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>可以参考各浏览器的开发文档：</p>
<ul>
<li>firefox: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Build_a_cross_browser_extension">https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Build_a_cross_browser_extension</a></li>
<li>edge: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/microsoft-edge/extensions-chromium/developer-guide/port-chrome-extension">https://docs.microsoft.com/zh-cn/microsoft-edge/extensions-chromium/developer-guide/port-chrome-extension</a></li>
<li>360: <a target="_blank" rel="noopener" href="http://open.se.360.cn/open/extension_dev/overview.html">http://open.se.360.cn/open/extension_dev/overview.html</a></li>
<li>搜狗: <a target="_blank" rel="noopener" href="http://ie.sogou.com/open/doc/">http://ie.sogou.com/open/doc/</a></li>
</ul>
<h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><p>chrome 发布插件需要花费 5 美元开通账号：<a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/webstore/register/">https://developer.chrome.com/docs/webstore/register/</a></p>
<p>firefox 发布文档：<a target="_blank" rel="noopener" href="https://addons.mozilla.org/en-US/developers/">https://addons.mozilla.org/en-US/developers/</a></p>
<p>edge：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/microsoft-edge/extensions-chromium/publish/create-dev-account">https://docs.microsoft.com/zh-cn/microsoft-edge/extensions-chromium/publish/create-dev-account</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/chrome_extension/" data-id="cl2ef05ld00018mmt2s176leg" data-title="chrome 插件开发入门" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/chrome-extensions/" rel="tag">chrome,extensions</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-design_patterns" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/design_patterns/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:34:05.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/design_patterns/">设计模式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h1><p>我们常提到的设计模式源自 1994 年出版的 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Design_Patterns">Design Patterns: Elements of Reusable Object-Oriented Software</a> 一书。</p>
<p>书中用 C++ 描述了 23 种常用的软件设计模式，这些模式可以分类如下：</p>
<ul>
<li><p>创建型，关注对象如何创建</p>
<ol>
<li>工厂方法 Factory Method</li>
<li>抽象工厂 Abstract Factory</li>
<li>建造者 Builder</li>
<li>原型 Prototype</li>
<li>单例 Singleton</li>
</ol>
</li>
<li><p>结构型</p>
<ol>
<li>适配器 Adapter</li>
<li>桥 Bridge</li>
<li>组合 Composite</li>
<li>装饰器 Decorator</li>
<li>门面 Facade</li>
<li>享元 Flyweight</li>
<li>代理 Proxy</li>
</ol>
</li>
<li><p>行为型</p>
<ol>
<li>责任链 Chain</li>
<li>命令 Command</li>
<li>解释器</li>
<li>迭代器</li>
<li>中介者</li>
<li>备忘录</li>
<li>观察者 Observer</li>
<li>状态 State</li>
<li>策略 Strategy</li>
<li>模版方法</li>
<li>访问者 Visitor</li>
</ol>
</li>
</ul>
<p>有些设计模式太常见，比如单例、迭代器。有些设计模式太偏，比如解释器、备忘录。<br>本文只会讲这些模式：工厂方法、装饰器、责任链、命令、中介者、状态、策略、访问者。</p>
<p>正文开始之前，需要说明的是：</p>
<p>有些设计模式是基于 C++&#x2F;Java 的 OOP 模式而产生的，其他语言不一定适用，或者有别的实现方式。</p>
<p>本文旨在了解设计模式的思想，而不在于形式。</p>
<p>在编码时切忌生搬硬套，明白原理，再结合自己使用的编程语言，写出 SOLID 代码才是学习设计模式的目的。</p>
<p>设计模式的目的不是减少代码数量，而是用抽象层将常变和相对不常变的代码隔开，从而收敛代码改动范围。</p>
<p>引入抽象层则会让代码量增加。这也是很多人困惑的一点，怎么本来几行的代码用了设计模式之后增长到一百多行？</p>
<h2 id="工厂方法"><a href="#工厂方法" class="headerlink" title="工厂方法"></a>工厂方法</h2><p>工厂方法是指用一个方法来构造对象，而不是直接调用构造方法。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Vehicle</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Benz</span> <span class="keyword">implements</span> <span class="title class_">Vehicle</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Camry</span> <span class="keyword">implements</span> <span class="title class_">Vehicle</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CarFactory</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Vehicle <span class="title function_">create</span><span class="params">(String brand)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;camry&quot;</span>.equals(brand)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Camry</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Benz</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 调用构造方法</span></span><br><span class="line">    <span class="type">Vehicle</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Benz</span>();</span><br><span class="line">    <span class="comment">// 工厂方法</span></span><br><span class="line">    <span class="comment">// camry 甚至可以通过 args 传递进来</span></span><br><span class="line">    <span class="type">Vehicle</span> <span class="variable">car2</span> <span class="operator">=</span> CarFactory.create(<span class="string">&quot;camry&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么使用工厂方法呢？</p>
<p><strong>因为 <code>new SomeClass</code> 来构建对象本质上属于硬编码，</strong>写死了类型。</p>
<p>为了将 object 的构建和使用分开，才引入了工厂函数作为中间抽象。</p>
<p>上面的例子中，使用工厂方法之后，还可以将 CarFactory.create 的参数写在配置文件，或者通过命令行传递。这样如果需要改变车辆品牌，只需要修改配置或者参数即可，不用修改编译代码。</p>
<p>仔细想一下，工厂方法其实和下面的代码没有本质区别。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入抽象</span></span><br><span class="line"><span class="comment">// getMax 返回 int 类型</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX</span> <span class="operator">=</span> getMax();</span><br></pre></td></tr></table></figure>

<p>之前 MAX 是硬编码的某个值，比如 100；<br>之后引入了函数 getMax，至于 getMax 返回的值是怎么来的我们不关心，只要是 int 类型即可。<br>getMax 的角色和工厂方法是一样的。</p>
<p>工厂方法在 Go 代码中随处可见，因为 Go 不支持 <code>new SomeStruct</code> 创建 object。比如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPerson</span><span class="params">(params Params)</span></span> *Person &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;Person&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="装饰器模式"><a href="#装饰器模式" class="headerlink" title="装饰器模式"></a>装饰器模式</h2><p><strong>装饰器用于增强原有的类型，而不改变暴露的接口。</strong></p>
<p>不去修改原有的类型，而是使用外挂或者是新类型。</p>
<p>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Writer</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="title function_">write</span><span class="params">(data <span class="type">byte</span>[])</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">W</span> <span class="keyword">implements</span> <span class="title class_">Writer</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="title function_">write</span><span class="params">(data <span class="type">byte</span>[])</span> &#123;</span><br><span class="line">    <span class="comment">// ... write data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Writer</span> <span class="variable">w</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">W</span>();</span><br></pre></td></tr></table></figure>

<p>现在需要对 write 进行增强，比如流控、批量等特性。可以保留 W 类不变，提供新的类型。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">W2</span> <span class="keyword">implements</span> <span class="title class_">Writer</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> Writer w;</span><br><span class="line"></span><br><span class="line">  W2(Writer w) &#123;</span><br><span class="line">    <span class="built_in">this</span>.w = w;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="title function_">write</span><span class="params">(data <span class="type">byte</span>[])</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;cache ...&quot;</span>);</span><br><span class="line">    w.write(data);</span><br><span class="line">    System.out.println(<span class="string">&quot;flush ...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Writer</span> <span class="variable">w</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">W2</span>(<span class="keyword">new</span> <span class="title class_">W</span>());</span><br></pre></td></tr></table></figure>

<p>上面的代码用 W2 对 W 做了一些增强，然后将 W2 的实例暴露给变量 w。<br>对于 w 来说，自己收到的还是符合 Writer 接口的 object。</p>
<p>在支持装饰器的语言中，可以很容易的实现。比如 JavaScript：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line">  <span class="comment">// clone 在其他地方实现</span></span><br><span class="line">  <span class="comment">// 将 cache 取出的数据 copy 一份</span></span><br><span class="line">  <span class="meta">@clone</span></span><br><span class="line">  <span class="title function_">get</span>(<span class="params">key: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (xxx) &#123;</span><br><span class="line">      <span class="keyword">return</span> xxx;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xxx) &#123;</span><br><span class="line">      <span class="keyword">return</span> yyy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> zzz;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看上面的代码，需求是将 cache 取出的数据深 copy 一份。</p>
<p>如果不用装饰器，我们需要修改 get 方法内部的逻辑。如果逻辑复杂，比如分支众多，很容易漏掉某个 return。</p>
<p>而用装饰器这种外挂，就不需要去关心 get 方法的实现，更简单也更干净。</p>
<h2 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a>责任链模式</h2><p>责任链类似流水线，在一条流水线上可以随意增加&#x2F;删除处理环节，常用于对网络请求的处理。</p>
<p>比如 Java 的 netty，JavaScript 的 express 都是这种模式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Pipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pipeline</span>();</span><br><span class="line"></span><br><span class="line">pipeline.add(handler1);</span><br><span class="line">pipeline.add(handler2);</span><br><span class="line">pipeline.add(handler3);</span><br><span class="line"></span><br><span class="line">pipeline.handle(request);</span><br></pre></td></tr></table></figure>

<p>使用责任链模式，我们需要仔细思考的是：</p>
<ol>
<li>handler 抽象接口的格式，入参和出参的类型，以及异常的处理。比如：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// handler 需要实现的接口</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">  handle(Request request, Response response) <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的接口类型表示 handler 的异常由外层的 Pipeline 处理。</p>
<ol start="2">
<li>handler 的流转与中断谁来控制。这个过程可以由外层的 Pipeline 来控制，也可以由 handler 自己来。比如：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">  <span class="comment">// 调用 next 可以执行下一个 handler</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Request request, Response response, Next next)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在支持函数的语言，比如 Go 和 JavaScript 中，通常 handler 是一个函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// express</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handler1</span>(<span class="params">request, response, next</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handler2</span>(<span class="params">request, response, next</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(handler1);</span><br><span class="line">app.<span class="title function_">use</span>(handler2);</span><br></pre></td></tr></table></figure>

<h2 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h2><p>命令模式用于将一组动作封装在一起，提供更简洁的接口。常用于事件相关的处理。</p>
<p>比如我们要依次执行 A B C 操作。那么可以把 A B C 封装成一个操作，暴露的接口如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Command</span> &#123;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SomeCommand</span> <span class="keyword">implements</span> <span class="title class_">Command</span> &#123;</span><br><span class="line">  <span class="comment">// 执行命令依赖的 object，或者上下文</span></span><br><span class="line">  <span class="keyword">private</span> A a;</span><br><span class="line">  <span class="keyword">private</span> B b;</span><br><span class="line">  <span class="keyword">private</span> C c;</span><br><span class="line"></span><br><span class="line">  SomeCommand(A a, B b, C c) &#123;</span><br><span class="line">    <span class="built_in">this</span>.a = a;</span><br><span class="line">    <span class="built_in">this</span>.b = b;</span><br><span class="line">    <span class="built_in">this</span>.c = c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  execute() &#123;</span><br><span class="line">    a.doSomething();</span><br><span class="line">    b.doSomething();</span><br><span class="line">    c.doSomething();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 封装了 A B C 的操作</span></span><br><span class="line">    <span class="type">SomeCommand</span> <span class="variable">someCommand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SomeCommand</span>(a, b, c);</span><br><span class="line">    someCommand.execute();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码中本来应该由 Main.main 调用 a b c 来执行某种操作。但是现在它只需要创建 SomeCommand 命令，再执行一个方法即可。</p>
<p>通过 SomeCommand 的封装，Main.main 的逻辑变得更为清晰。在 Main.main 中增加更多的 command 也会更容易。</p>
<p>常见的应用：编辑器里复制按钮点击，需要执行复制操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复制按钮被点击了</span></span><br><span class="line"><span class="type">CopyCommand</span> <span class="variable">command</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CopyCommand</span>(editor);</span><br><span class="line"><span class="comment">// 具体的复制实现可以交给其他同学来完成</span></span><br><span class="line"><span class="comment">// 调用方不需要关心细节</span></span><br><span class="line">command.execute();</span><br></pre></td></tr></table></figure>

<h2 id="中介者模式"><a href="#中介者模式" class="headerlink" title="中介者模式"></a>中介者模式</h2><p>当系统中多个模块相互耦合时，可以引入一个中间抽象，然后这些模块都依赖这个中间抽象，将网状拓扑简化成星型拓扑，依赖复杂度由 M*N 变成 N+1。</p>
<p>中介者典型的应用有 MVC 架构、EventBus、MessageQueue 或者 NodeJS 的 EventEmitter。</p>
<h2 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h2><p>假设一个 object 有 N 种状态和 M 种行为，状态和行为之间互相影响。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">State</span> &#123;</span><br><span class="line">  <span class="comment">// 电梯暂停</span></span><br><span class="line">  Pause,</span><br><span class="line">  <span class="comment">// 电梯上下运行中</span></span><br><span class="line">  Running,</span><br><span class="line">  <span class="comment">// 电梯门开</span></span><br><span class="line">  Open;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 电梯</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Lift</span> &#123;</span><br><span class="line">  State state;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">open</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (state == State.Running) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Can&#x27;t open when running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;open...&quot;</span>);</span><br><span class="line">    state = State.Open;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (state == State.Running) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Can&#x27;t close when running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;close...&quot;</span>);</span><br><span class="line">    state = State.Pause;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (state == State.Open) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Close first&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;run...&quot;</span>);</span><br><span class="line">    state = State.Running;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">pause</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (state == State.Open) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Close first&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    state = State.Pause;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看到，电梯的状态和行为相互影响，都放在电梯类里。</p>
<p>目前电梯的状态和行为很少这么写问题不大，但是随着状态和行为的扩展，整个 Lift 类的代码交织在一起，会陷入失控。</p>
<p>引入状态模式可以解决扩展的问题：</p>
<ol>
<li>将每个状态拆成独立的 class，它们实现共同的接口，包括几乎所有的 Lift 行为。</li>
<li>Lift 只保存一个状态 object，而状态的流转和行为的控制则由这个 object 处理，因为每个状态知道自己的下一个状态是什么。</li>
</ol>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有 state 类需要继承</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">State</span> &#123;</span><br><span class="line">  <span class="comment">// State 需要持有 Lift</span></span><br><span class="line">  <span class="comment">// 以便实现 lift 的状态流转</span></span><br><span class="line">  <span class="keyword">protected</span> Lift lift;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">State</span><span class="params">(Lift lift)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.lift = lift;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">()</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">pause</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OpenState 只关注 open 状态下的逻辑</span></span><br><span class="line"><span class="comment">// 这样单个 State 的逻辑就很清晰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpenState</span> <span class="keyword">extends</span> <span class="title class_">State</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Alread open&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Close&quot;</span>);</span><br><span class="line">    <span class="comment">// 流转到下一个状态</span></span><br><span class="line">    lift.setState(<span class="keyword">new</span> <span class="title class_">PauseState</span>(lift));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Close first&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pause</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Close first&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RunningState</span> <span class="keyword">extends</span> <span class="title class_">State</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PauseState</span> <span class="keyword">extends</span> <span class="title class_">State</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Lift</span> &#123;</span><br><span class="line">  <span class="comment">// 初始状态</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">State</span> <span class="variable">state</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RunningState</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(State state)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = state;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 所有行为委托给 state 处理</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">open</span><span class="params">()</span> &#123;</span><br><span class="line">    state.open();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">    state.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    state.run();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">pause</span><span class="params">()</span> &#123;</span><br><span class="line">    state.pause();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，每个状态专注自身的逻辑。每增加一个状态，只需要增加一个对应的 State 类即可。</p>
<p>也有小小的缺点：每增加一个行为，则要修改全部的 State 类。</p>
<p>比较：你是愿意在一个大箱子里面找东西？还是愿意在分类更清晰的三个小箱子里面找东西？</p>
<h2 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h2><p>设想这种场景：一份数据可能会做不同的处理。</p>
<p>这种情况下，数据一般是相对不易改变的部分，这里指的是数据的结构，而非具体的数值。对数据的处理逻辑可能会经常改变。</p>
<p>还是那句话：在不常变和常变之间做出区分，引入中间抽象把它们隔离开。</p>
<p>把数据的处理提取成接口，剥离处理方法的具体实现，这种方式被成为策略模式。</p>
<p>最简单常见的策略模式如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nums = [<span class="number">4</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从小到大</span></span><br><span class="line">nums.<span class="title function_">sort</span>(<span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> a - b;</span><br><span class="line">  <span class="comment">// 从大到小</span></span><br><span class="line">  <span class="keyword">return</span> b - a;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从大到小</span></span><br><span class="line">nums.<span class="title function_">sort</span>(<span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> b - a;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>nums 数组提供了一个 sort 方法，具体怎么排序则由调用方自己决定，只要排序函数满足接口即可。</p>
<p>这样 nums 就不用提供 sortMinToMax&#x2F;sortMaxToMin 等排序方法，调用方爱怎么排序就怎么排序，自己来。</p>
<p>策略模式还有一个很经典的应用场景：消息通信中，对不同的消息做不同的处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> code;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">byte</span>[] data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对消息的处理可以抽象成共同的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">MsgHandler</span> &#123;</span><br><span class="line">  <span class="comment">// 可以处理的消息 code</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span>[] codes;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Message msg)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息处理的实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MsgHandler404</span> <span class="keyword">extends</span> <span class="title class_">MsgHandler</span> &#123;</span><br><span class="line">  MsgHandler404() &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.codes = &#123;</span><br><span class="line">      <span class="number">404</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">    <span class="comment">// ... doSomething</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Handlers</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> Map&lt;Integer, List&lt;MsgHandler&gt;&gt; handlers = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// register 提供消息处理器的插拔机制</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(MsgHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; handler.codes.length; i++) &#123;</span><br><span class="line">      <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> handler.codes[i];</span><br><span class="line">      List&lt;MsgHandler&gt; list = handlers.get(code);</span><br><span class="line">      <span class="keyword">if</span> (list == <span class="literal">null</span>) &#123;</span><br><span class="line">        list = ArrayList&lt;MsgHandler&gt;();</span><br><span class="line">        handlers.put(code, list);</span><br><span class="line">      &#125;</span><br><span class="line">      list.add(handler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不再使用 switch (msg.code) 的方式处理消息</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">    List&lt;MsgHandler&gt; list = handlers.get(msg.code);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">      <span class="type">MsgHandler</span> <span class="variable">handler</span> <span class="operator">=</span> list.get(i);</span><br><span class="line">      handler.handle(msg);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="访问者模式"><a href="#访问者模式" class="headerlink" title="访问者模式"></a>访问者模式</h2><p>访问者表示对数据的访问和处理。</p>
<p>访问者模式和策略模式有些像，都是强调数据本身与数据的处理逻辑相分离。</p>
<p>但是访问者模式通常适用于对数据做出比较复杂的处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Data</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Visitor</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> Data data;</span><br><span class="line"></span><br><span class="line">  Visitor(Data data) &#123;</span><br><span class="line">    <span class="built_in">this</span>.data = data;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  SomeInfo <span class="title function_">report</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ... 处理数据</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以把访问者看作对数据的视图，或者 PhotoShop 的蒙板。<br>圆形的蒙板展示的数据是圆形，方形的蒙板展示的数据则是方形。</p>
<p>比如对于同一份字节数据，可以解析成不同的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ByteBuffer</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">byte</span>[] data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 bytes 解析成 uint8 类型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Uint8View</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> ByteBuffer buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 bytes 解析成 int16 类型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Int16View</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> ByteBuffer buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上就是本文的全部内容了，欢迎评论点赞分享，或者关注公众号【写好代码】，谢谢。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/design_patterns/" data-id="cl2ef05lg00028mmt84lrbatj" data-title="设计模式" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-forever" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/forever/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:34:05.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/forever/">后台运行 NodeJS</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="后台运行-NodeJS"><a href="#后台运行-NodeJS" class="headerlink" title="后台运行 NodeJS"></a>后台运行 NodeJS</h1><p>最近一个项目需要写个小型的后端程序，主要是功能比较简单，但是后端同学比较忙，所以用 node 写了</p>
<p>但是终端连接到服务器，运行 <code>node server.js</code>， 退出终端之后，程序就停止运行了。</p>
<p>最后使用 forever 包搞定，解决方案如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo npm install -g forever --registry=http://registry.cnpmjs.org</span><br><span class="line">forever start 脚本文件</span><br></pre></td></tr></table></figure>

<p><code>forever list</code> 查看所有 forever 运行的进程<br><code>forever stop uid</code> 停止运行指定 uid 的进程</p>
<p>更多用法请参考 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/forever">forever</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/forever/" data-id="cl2ef05lj00048mmtbthgbbz9" data-title="后台运行 NodeJS" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/forever/" rel="tag">forever</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-git" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/git/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:34:05.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/git/">git 常用命令</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://git-scm.com/">git</a> 可以说是目前最优秀的代码版本管理工具，团队开发是少不了的。本文会介绍一些常用的 git 命令。</p>
<p>git 仓库划分了 3 类区域，分别是： 工作区，暂存区，分支（master 及 其他分支）</p>
<p>工作区 简单来说就是我们仓库的当前目录<br>暂存区 和 分支 在 仓库主目录的 .git 这个隐藏目录中</p>
<p><code>git init 目录</code> 将指定目录初始化为 git 仓库<br><code>git clone 仓库地址</code> 拉取远程仓库到当前目录<br><code>git clone -b 分支名称 仓库地址</code> 拉取远程仓库的指定分支到当前目录</p>
<p>1、<code>git status</code> 查看仓库的状态，会显示工作区和暂存区的状态<br>比如：工作区有修改，有新文件，未添加到暂存区。或者暂存区有操作未提交到分支</p>
<p>2、<code>git add 文件/目录</code> 将文件，目录添加到暂存区</p>
<p>3、<code>git commit -m &#39;本次代码更新的注释&#39;</code><br>将暂存区的操作，提交到当前分支（一般都是默认的 master 分支）<br>所以你在工作区的操作，如果没有 add 到暂存区，是不会被提交到分支的</p>
<p>4、<code>git log</code> 查看分支提交历史<br><code>git log --oneline</code> 更简洁易懂的方式查看历史<br><code>git log -n</code> 查看最近 n 条历史<br><code>git log --stat</code> 查看历史的详细信息，那些文件有变更，分别添加、删除、修改了多少行<br><code>git log -p</code> 查看历史的详细信息，比 –stat 更加详细，会把每个文件变更的内容列出来，比如添加的 3 行内容是什么。</p>
<p>参数可以组合，<code>git log -2 -p</code> 查看最近 2 条历史的详细信息</p>
<p>5、撤销操作<br>a、新建了文件，还未添加到暂存区，不想要了。直接删除这个新文件即可。<br>b、已经纳入版本管理的文件，在工作区做了修改，还未添加到暂存区。使用 <code>git checkout -- 文件</code> 撤销工作区的修改，回到上次添加到暂存区的状态。</p>
<p>c、已经纳入版本管理的文件，在工作区做了修改，而且已经添加到了暂存区。这时候即需要撤销暂存区的状态，又需要撤销工作区的操作，对应也有两条命令。<br>撤销暂存区状态：<code>git reset HEAD</code><br>撤销工作区修改：<code>git checkout -- 文件</code></p>
<p>5、HEAD 指的是当前分支的当前版本。<br>git reset HEAD 是将暂存区回到<code>当前分支当前版本</code>的状态。这点比较绕，暂存区还未提交到分支，所以暂存区的文件相比<code>分支的当前版本</code>是要新的。</p>
<p>–hard 参数，覆盖工作区和暂存区<br>git reset –hard HEAD 使用 当前分支当前版本 的状态覆盖暂存区和工作区。会导致工作区所有最近的操作都撤销。所以如果你只是想撤销某一个文件的修改，别用这个命令。</p>
<p>git reset HEAD~1 回到 <code>当前分支的前一个版本</code>，数字 1 也可以改成 2，3，4，5…<br>git reset 版本号 也能回到指定版本</p>
<p>6、<code>git reflog</code> 查看操作记录</p>
<p>7、删除文件<br>a、<code>git rm 文件</code> 从工作区删除文件，并且将删除记录到暂存区。<br>相当于两个步骤 <code>rm 文件</code> 从工作区删除文件，再 <code>git add 文件</code> 将删除记录到暂存区。<br>b、<code>git commit -m &#39;注释&#39;</code> 将暂存区变更提交到分支，从而在分支上也删除文件</p>
<p>如果文件有修改，记录并未添加到暂存区，或者添加到了暂存区，并未提交到分支。<br>git rm 文件 会失败，需要用 <code>git rm 文件 -f</code> 强制删除</p>
<p>8、比较文件<br><code>git diff [文件]</code> 比较工作区和暂存区<br><code>git diff --staged [文件]</code> 比较暂存区和分支</p>
<p>9、重命名，移动<br><code>git mv 旧文件 新文件</code> 既可以命名，又可以移动。实际相当于两个步骤<br><code>git rm 旧文件</code> 再 <code>git add 新文件</code></p>
<p>配置 git 命令简写，当然你还可以配置的更多</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --global alias.st status</span><br><span class="line">git config --global alias.co checkout</span><br><span class="line">git config --global alias.ci commit</span><br></pre></td></tr></table></figure>

<p>或者 vim ~&#x2F;.gitconfig<br>在最后面添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[alias]</span><br><span class="line">    st = status</span><br><span class="line">    co = checkout</span><br><span class="line">    ci = commit</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/git/" data-id="cl2ef05lk00058mmt0amtcl91" data-title="git 常用命令" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/" rel="tag">git</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-json_schema" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/json_schema/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:34:05.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/json_schema/">JSON schema 教程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="JSON-schema-教程"><a href="#JSON-schema-教程" class="headerlink" title="JSON schema 教程"></a>JSON schema 教程</h1><p>静态语言通常会声明一个结构描述 JSON 类型，比如 Java 的 class。但是由于 JavaScript 是弱类型语言，缺乏可靠的机制来验证 JSON 的结构和类型。</p>
<p>如果有通用的校验规则和工具，那就能减少手写校验代码的工作量，而且可以复用到很多场景，比如编辑器智能提示。</p>
<p>JSON schema 就可以解决这个问题。</p>
<h2 id="JSON-schema-是什么"><a href="#JSON-schema-是什么" class="headerlink" title="JSON schema 是什么"></a>JSON schema 是什么</h2><p>首先，JSON schema 是一个规范，它约定了一些关键字和写法，可以用来描述目标 JSON 的结构。</p>
<p>其次，JSON schema 文件也是一个 JSON 文件，需要符合 JSON 语法。</p>
<p>JSON schema 之于 JSON 就像 XML Schema 之于 XML。</p>
<p>具体语法可以在参考：<a target="_blank" rel="noopener" href="https://json-schema.org/%E3%80%82">https://json-schema.org/。</a></p>
<p>比如我们需要的数据需要符合以下两点：</p>
<ol>
<li>是一个 JSON object。</li>
<li>有一个必需的 name 属性，值为 string 类型。</li>
</ol>
<p>那可以这么写 JSON schema：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>很多语言都提供了 JSON schema 工具可以使用，参考：<a target="_blank" rel="noopener" href="https://json-schema.org/implementations.html">https://json-schema.org/implementations.html</a></p>
<p>也可以使用<a target="_blank" rel="noopener" href="https://www.jsonschemavalidator.net/">在线工具</a>体验 JSON schema 的作用。</p>
<h2 id="JSON-schema-基本语法"><a href="#JSON-schema-基本语法" class="headerlink" title="JSON schema 基本语法"></a>JSON schema 基本语法</h2><h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p>除了前面看到的 object 和 string，所有 type 如下：</p>
<table>
<thead>
<tr>
<th>type</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>object</td>
<td>JSON object</td>
</tr>
<tr>
<td>array</td>
<td>数组</td>
</tr>
<tr>
<td>number</td>
<td>整数或浮点数</td>
</tr>
<tr>
<td>integer</td>
<td>整数</td>
</tr>
<tr>
<td>string</td>
<td>字符串</td>
</tr>
<tr>
<td>boolean</td>
<td>布尔值</td>
</tr>
<tr>
<td>null</td>
<td>null</td>
</tr>
</tbody></table>
<p>type 也可以是以上类型组成的数组，表示数组内的任一类型都可以。</p>
<p>比如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;number&quot;</span><span class="punctuation">,</span> <span class="string">&quot;string&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以匹配 123 和 “xiaoming”.</p>
<p>JSON schema 允许使用 <code>true</code> 表示任意类型。比如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>JSON schema 为每个 type 提供了独特的属性用来校验。</p>
<h3 id="number-和-integer-的校验"><a href="#number-和-integer-的校验" class="headerlink" title="number 和 integer 的校验"></a>number 和 integer 的校验</h3><p>数字独特的校验属性如下：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>type</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>multipleOf</td>
<td>number</td>
<td>需要是指定值的倍数，该属性值必须是正数</td>
</tr>
<tr>
<td>maximum</td>
<td>number</td>
<td>最大值，可以相等</td>
</tr>
<tr>
<td>minimum</td>
<td>number</td>
<td>最小值，可以相等</td>
</tr>
<tr>
<td>exclusiveMaximum</td>
<td>number</td>
<td>最大值，不能相等</td>
</tr>
<tr>
<td>exclusiveMinimum</td>
<td>number</td>
<td>最小值，不能相等</td>
</tr>
</tbody></table>
<p>假如我们想要一个数字是 3.2 的倍数，可以这么写：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;multipleOf&quot;</span><span class="punctuation">:</span> <span class="number">3.2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="string-的校验"><a href="#string-的校验" class="headerlink" title="string 的校验"></a>string 的校验</h3><p>string 类型有如下校验属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>type</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>maxLength</td>
<td>number</td>
<td>最长字符数</td>
</tr>
<tr>
<td>minLegnth</td>
<td>number</td>
<td>最短字符数</td>
</tr>
<tr>
<td>pattern</td>
<td>string</td>
<td>必须匹配指定的正则字符串</td>
</tr>
</tbody></table>
<p>可以使用 pattern 属性声明手机号：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1\\d&#123;10&#125;$&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="object-的校验"><a href="#object-的校验" class="headerlink" title="object 的校验"></a>object 的校验</h3><h4 id="properties"><a href="#properties" class="headerlink" title="properties"></a>properties</h4><p>如果 type 是 object，可以用 <strong>properties</strong> 描述 object 的结构。</p>
<p>properties 是一个 k-v 结构，k 表示 object 的属性，v 还是一个 JSON schema，描述属性值的结构。</p>
<p>比如声明一个 object 有 name 和 age 属性：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用前文提到的 <code>true</code> 可以表示不限制字段的类型，如下不限制 extra 字段的值类型。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;extra&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果没有 properties 约束的话，这个 JSON object 内部的结构可以是任意的。</p>
<p>如果属性值是 object 类型，还可以用 properties 描述这个属性值的结构。</p>
<p>可以用下面 schema 片段用来声明文章的标题和作者：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// creator 属性的描述也是一个 JSON schema</span></span><br><span class="line">    <span class="attr">&quot;creator&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="required"><a href="#required" class="headerlink" title="required"></a>required</h4><p>默认情况下 properties 里声明的属性都是可选的，可以不存在。</p>
<p>可以使用 <strong>required</strong> 属性声明 object 必需的属性列表。</p>
<p>如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>上面的 schema 声明 name 属性是必需的，而 age 属性是可选的。</p>
<h4 id="maxProperties-和-minProperties"><a href="#maxProperties-和-minProperties" class="headerlink" title="maxProperties 和 minProperties"></a>maxProperties 和 minProperties</h4><p>JSON schema 描述的结构是我们想要的最小结构，实际收到的数据是可以有额外字段的。</p>
<p><strong>maxProperties</strong> 和 <strong>minProperties</strong> 可以指定属性的数量，从而禁止额外属性。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span> <span class="string">&quot;age&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;maxProperties&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;minProperties&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这样就只能有 name 和 age 两个属性了。</p>
<h3 id="array-的校验"><a href="#array-的校验" class="headerlink" title="array 的校验"></a>array 的校验</h3><h4 id="items"><a href="#items" class="headerlink" title="items"></a>items</h4><p>如果 type 是 array，可以用 <strong>items</strong> 属性描述数组的元素。</p>
<p>可以这么声明字符串数组。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>items 属性可以是一个数组，用来描述数组的不同元素。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果提供的数组多于两项，那么多出来的元素不会进行校验，也就是说 <code>[&#39;xiaoming&#39;, 20, true]</code> 也是可以校验通过的。</p>
<h4 id="minItems-和-maxItems"><a href="#minItems-和-maxItems" class="headerlink" title="minItems 和 maxItems"></a>minItems 和 maxItems</h4><p>可以用 minItems 和 maxItems 属性声明数组最少有几个元素、最多有几个元素。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;maxItems&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;minItems&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="uniqueItems"><a href="#uniqueItems" class="headerlink" title="uniqueItems"></a>uniqueItems</h4><p>uniqueItems 属性为 true 表示数组中的元素不能重复。</p>
<p>如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uniqueItems&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="公共属性"><a href="#公共属性" class="headerlink" title="公共属性"></a>公共属性</h3><p>还有一些用于描述和校验的公共属性。</p>
<h4 id="title-和-description"><a href="#title-和-description" class="headerlink" title="title 和 description"></a>title 和 description</h4><p>title 和 description 主要是用来对字段进行说明，使 JSON schema 更友好。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;注册表单&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;用户名&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;用户名不能重复&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;maxLength&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;minLength&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^[\\w]&#123;8,16&#125;$&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;密码&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8至16位英文字母和数字组合&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;username&quot;</span><span class="punctuation">,</span> <span class="string">&quot;password&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="enum"><a href="#enum" class="headerlink" title="enum"></a>enum</h4><p>enum 属性可以限定值的范围。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;normal&quot;</span><span class="punctuation">,</span> <span class="string">&quot;readonly&quot;</span><span class="punctuation">,</span> <span class="string">&quot;hidden&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>enum 也可以用来限定 object 和 array 这种复杂结构。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">[</span><span class="string">&quot;xiaoming&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="number">20</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="const"><a href="#const" class="headerlink" title="const"></a>const</h4><p>const 表示只能是指定的值，相当于长度为 1 的 enum 列表。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;const&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xiaoming&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="default"><a href="#default" class="headerlink" title="default"></a>default</h4><p>default 用来提供默认值。</p>
<p>如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在用 JSON schema 构建表单或者配置文件时，可以使用 <strong>default</strong> 字段获取默认值。</p>
<h4 id="oneOf-allOf-anyOf-not"><a href="#oneOf-allOf-anyOf-not" class="headerlink" title="oneOf allOf anyOf not"></a>oneOf allOf anyOf not</h4><p>假如我们想要一个 object，它只能有 name 属性或 age 属性，应该怎么实现呢？</p>
<p>可以用 oneOf 来描述。如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;oneOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;age&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;minProperties&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;maxProperties&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>oneOf 的值是一个 JSON schema 数组，每一项都可以用来约束结构。目标只能匹配其中一项，否则就会校验失败。</p>
<p>同理，allOf 需要匹配所有结构，anyOf 匹配任意一个或多个结构。</p>
<p>not 则要求不能匹配指定的结构。</p>
<p>下面的 schema 要求目标 object 不能有 name 属性。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;not&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="if-then-else"><a href="#if-then-else" class="headerlink" title="if then else"></a>if then else</h4><p>if then else 可以实现更复杂的条件结构。</p>
<p>下面的 schema 表示，如果 phone 属性存在且值是字符串，那么就不能再有 email 属性。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;if&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;phone&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;then&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;not&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;email&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="片段复用"><a href="#片段复用" class="headerlink" title="片段复用"></a>片段复用</h2><p>为了避免同样的描述重复很多次，JSON schema 提供了复用的机制。</p>
<p>一般用 <strong>$defs</strong> 或 <strong>definitions</strong> 属性定义一些片段，用 <strong>$ref</strong> 引用。</p>
<p>如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;$defs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;key&quot;</span><span class="punctuation">,</span> <span class="string">&quot;op&quot;</span><span class="punctuation">,</span> <span class="string">&quot;value&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;and&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/$defs/filter&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;and&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>$ref</strong> 的路径以 # 开头表示当前 JSON schema 文档，后面跟上节点的路径。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/json_schema/" data-id="cl2ef05ll00068mmtfz263pzu" data-title="JSON schema 教程" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/json-schema/" rel="tag">json,schema</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-passive_touch" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/passive_touch/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:34:05.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/passive_touch/">Unable to preventDefault inside passive event listener</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Unable-to-preventDefault-inside-passive-event-listener"><a href="#Unable-to-preventDefault-inside-passive-event-listener" class="headerlink" title="Unable to preventDefault inside passive event listener"></a>Unable to preventDefault inside passive event listener</h1><p>最近做项目经常在 chrome 的控制台看到如下提示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unable to preventDefault inside passive event listener due to target being treated as passive. See https://www.chromestatus.com/features/5093566007214080</span><br></pre></td></tr></table></figure>

<p>于是 Google 了一番，找到这篇文章，有了详细解释。<a target="_blank" rel="noopener" href="https://developers.google.com/web/updates/2017/01/scrolling-intervention">Making touch scrolling fast by default</a></p>
<p>简而言之：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">由于浏览器必须要在执行事件处理函数之后，才能知道有没有掉用过 preventDefault() ，这就导致了浏览器不能及时响应滚动，略有延迟。</span><br><span class="line"></span><br><span class="line">所以为了让页面滚动的效果如丝般顺滑，从 chrome56 开始，在 window、document 和 body 上注册的 touchstart 和 touchmove 事件处理函数，会默认为是 passive: true。浏览器忽略 preventDefault() 就可以第一时间滚动了。</span><br><span class="line"></span><br><span class="line">举例：</span><br><span class="line">wnidow.addEventListener(&#x27;touchmove&#x27;, func) 效果和下面一句一样</span><br><span class="line">wnidow.addEventListener(&#x27;touchmove&#x27;, func, &#123; passive: true &#125;)</span><br></pre></td></tr></table></figure>

<p>这就导致了一个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果在以上这 3 个元素的 touchstart 和 touchmove 事件处理函数中调用 e.preventDefault() ，会被浏览器忽略掉，并不会阻止默认行为。</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">body &#123;</span><br><span class="line">  margin: 0;</span><br><span class="line">  height: 2000px;</span><br><span class="line">  background: linear-gradient(to bottom, red, green);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 在 chrome56 中，照样滚动，而且控制台会有提示，blablabla</span><br><span class="line">window.addEventListener(&#x27;touchmove&#x27;, e =&gt; e.preventDefault())</span><br></pre></td></tr></table></figure>

<p>那么如何解决这个问题呢？不让控制台提示，而且 preventDefault() 有效果呢？<br>两个方案：<br>1、注册处理函数时，用如下方式，明确声明为不是被动的<br>window.addEventListener(‘touchmove’, func, { passive: false })</p>
<p>2、应用 CSS 属性 <code>touch-action: none;</code> 这样任何触摸事件都不会产生默认行为，但是 touch 事件照样触发。<br>touch-action 还有很多选项，详细请参考<a target="_blank" rel="noopener" href="https://w3c.github.io/pointerevents/#the-touch-action-css-property">touch-action</a></p>
<p>[注]未来可能所有的元素的 touchstart touchmove 事件处理函数都会默认为 passive: true</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/passive_touch/" data-id="cl2ef05ln00098mmtg87x2ihe" data-title="Unable to preventDefault inside passive event listener" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/event-passive/" rel="tag">event,passive</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-tcp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/tcp/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:34:05.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/tcp/">从 TCP 说起</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本文从应用的角度以简单直白的代码事例，让大家透彻的理解 TCP 以及 HTTP、RPC、websocket 等常见应用协议。</p>
<p><strong>阅读文本需要有基础的 TCP&#x2F;IP 网络模型知识</strong></p>
<p>TCP&#x2F;IP 是互联网的基石，随着通信技术的发展，5G 势必会产生更多样的网络应用，而应用又可能会催生新的网络协议（比如 http2&#x2F;3，webRTC, web 支付）。</p>
<p>作为软件工程师的我们，在面对这些未知挑战时更应该去了解 TCP，它就像是定海神针能够让我们以不变应万变。</p>
<h2 id="TCP-和-socket"><a href="#TCP-和-socket" class="headerlink" title="TCP 和 socket"></a>TCP 和 socket</h2><p><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc793">TCP 协议标准</a>制定于 1981 年，是一个非常复杂的协议，包括了可靠性保证（握手&#x2F;挥手、ACK 确认）、拥塞控制算法（滑动窗口、慢启动）等内容。</p>
<p>1983 年 Berkeley 在 BSD4.2 系统中发布了 <code>Berkeley sockets API</code>（下文简称 socket） 作为 TCP 的代码实现，之后 socket 被移植到 windows linux 等众多操作系统中。可以说目前我们使用的网络编程技术几乎全部基于 socket。</p>
<p>总结一下：TCP 是非常复杂的协议，socket 是 TCP 的一种代码实现。</p>
<p>下面是一段 socket 代码，我们看看最原始的网络编程是怎样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* 1. 创建 socket</span></span><br><span class="line"><span class="comment">   * AF_INET 表示用于创建 IPv4 网络的 socket</span></span><br><span class="line"><span class="comment">   * SOCK_STREAM 表示用于 TCP 网络（还可以使用 SOCK_DGRAM 创建 UDP socket）</span></span><br><span class="line"><span class="comment">   * socket 函数文档：https://man7.org/linux/man-pages/man2/socket.2.html</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">int</span> socket_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (socket_fd == <span class="number">-1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;failed to create socket\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 将 socket 绑定网络接口（IP + 端口）</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">  address.sin_family = AF_INET;</span><br><span class="line">  address.sin_addr.s_addr = INADDR_ANY; <span class="comment">// 相当于 0.0.0.0</span></span><br><span class="line">  address.sin_port = htons(<span class="number">8888</span>);</span><br><span class="line">  <span class="comment">// https://man7.org/linux/man-pages/man2/bind.2.html</span></span><br><span class="line">  <span class="type">int</span> code = bind(socket_fd, &amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">  <span class="keyword">if</span> (code &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;failed to bind net interface\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. 开始监听连接</span></span><br><span class="line">  <span class="comment">// 第二个参数称为 backlog，用于指定等待连接的队列长度。</span></span><br><span class="line">  <span class="comment">// listen 函数文档，https://man7.org/linux/man-pages/man2/listen.2.html</span></span><br><span class="line">  code = listen(socket_fd, <span class="number">1024</span>);</span><br><span class="line">  <span class="keyword">if</span> (code &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;failed to listen at 0.0.0.0:8888\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;listen at 0.0.0.0:8888\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. pending 队列中取出连接</span></span><br><span class="line">  <span class="comment">// https://man7.org/linux/man-pages/man2/accept.2.html</span></span><br><span class="line">  <span class="type">int</span> conn;</span><br><span class="line">  <span class="keyword">while</span> ((conn = accept(socket_fd, <span class="literal">NULL</span>, <span class="literal">NULL</span>)))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> *message = <span class="string">&quot;Hello\n&quot;</span>;</span><br><span class="line">    <span class="comment">// 向 client 发送消息</span></span><br><span class="line">    write(conn, message, <span class="built_in">strlen</span>(message));</span><br><span class="line">    <span class="comment">// 关闭链接</span></span><br><span class="line">    close(conn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(socket_fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译执行以上代码，就可以在本地建立 server 了，然后用 telnet 连接：</p>
<p><img src="/images/tcp/telnet.png" alt="telnet.png"></p>
<p>server 发送了 <code>Hello</code> 之后，关闭了链接。</p>
<p>开发 Unix 的大神们（Ken Thompson, Rob Pike 等）又开发了一个名为 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Plan_9_from_Bell_Labs">plan9</a> 的操作系统，它的网络编程更为简单，可以参考：<a target="_blank" rel="noopener" href="http://doc.cat-v.org/plan_9/4th_edition/papers/net/%E3%80%82%E5%8F%AF%E6%83%9C">http://doc.cat-v.org/plan_9/4th_edition/papers/net/。可惜</a> plan9 并没有像 Unix 一样有着革命性的影响，反而绝大多数开发者并没有听过这个系统。<br>不过令人欣慰的是 plan9 的理念被 Go 语言继承下来，并将在现在的网络开发中发挥光热。</p>
<h2 id="TCP-粘包"><a href="#TCP-粘包" class="headerlink" title="TCP 粘包"></a>TCP 粘包</h2><p>为了方便，下面的 server 只处理一条链接。实际开发中，会用多线程加 AIO 的方式并发处理多条链接。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新上文 listen 和 return 之间的代码</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> buffer_size = <span class="number">11</span>;</span><br><span class="line"><span class="type">char</span> buffer[buffer_size];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; buffer_size; i++) &#123;</span><br><span class="line">  buffer[i] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> conn = accept(socket_fd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">// 每次从链接中最多读取10个字节</span></span><br><span class="line">  <span class="type">int</span> count = read(conn, &amp;buffer, buffer_size<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;connection end&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  buffer[count] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;receive message from client:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新编译启动 server，再用 telnet 连接 server 发送 <code>hello world</code>，查看 server 的输出：</p>
<p><img src="/images/tcp/echo.png" alt="echo.png"></p>
<p>可以看到 server 端把 <code>hello world</code> 这么一条完整端消息拆成了两条来处理。</p>
<p>为什么会有这个问题呢？</p>
<p>首先 client 发送的任何数据（文本、JSON、图片、视频、音频）最终都会作为字节在网络中传递，TCP 不知道这些数据是什么，只是一串字节而已。</p>
<p>其次 server 每次只读取 10 个字节，而 client 发送的消息长度为 11 字节，所以 server 分成了两次读取并处理，第 11 个字符在第二次才读取到。</p>
<p>我们可以一次读取更多字节，比如 1024 字节。但是本质的问题并没有解决：如果 client 每次发送的消息长度都是不定的，server 要怎么从一串字节中正确的分割消息呢？</p>
<p>这也就是所谓的 TCP 粘包问题。注意：这不是 TCP 的问题，而是应用层需要处理的问题。</p>
<p>通常有这么几个思路：</p>
<ol>
<li>保证消息的长度是一致的。缺点是不够灵活。</li>
<li>用一个或几个特定字符作为消息的分隔符。缺点是对消息的编码要求比较高，而且消息的分割效率不高。</li>
<li>消息遵守特定的编码，在消息中包含消息的长度。这是目前比较广泛的做法。</li>
</ol>
<p>接下来我们按照第 3 种方法实现一个简单的消息编码规则：</p>
<ol>
<li>首字节表示消息的 code。</li>
<li>接下来的 3 个字节表示消息体的长度。这就说明消息体最多有 1&lt;&lt;24 - 1 个字节，大约 16MB。</li>
<li>后面跟着消息体。</li>
</ol>
<p>server 的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 替换上文 bind 后面的代码</span></span><br><span class="line"><span class="type">char</span> msg_hd[<span class="number">4</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> conn = accept(socket_fd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 先读取消息 code 和长度</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    msg_hd[i] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> count = read(conn, &amp;msg_hd, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> (count &lt; <span class="number">4</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;connection end: short head&quot;</span>);</span><br><span class="line">    close(conn);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;receive message from client:\n&quot;</span>);</span><br><span class="line">  <span class="type">char</span> code = msg_hd[<span class="number">0</span>];</span><br><span class="line">  <span class="type">int</span> len = msg_hd[<span class="number">1</span>] + (msg_hd[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) + (msg_hd[<span class="number">3</span>] &lt;&lt; <span class="number">16</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;code: %d, message length: %d\n&quot;</span>, code, len);</span><br><span class="line">  <span class="comment">// 读取消息体</span></span><br><span class="line">  <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> buffer[len + <span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> count = read(conn, &amp;buffer, len);</span><br><span class="line">    <span class="keyword">if</span> (count &lt; len)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;connection end: short body&quot;</span>);</span><br><span class="line">      close(conn);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    buffer[count] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;message [%s]\n&quot;</span>, buffer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于对消息进行了二进制编码，就不能直接用 telnet 来发起请求了。使用 nodejs 脚本如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = net.<span class="title function_">connect</span>(<span class="number">8888</span>, <span class="string">&#x27;localhost&#x27;</span>, <span class="function">(<span class="params">conn</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;connected to server.&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hello = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([</span><br><span class="line">  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>])),</span><br><span class="line">  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> world = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([</span><br><span class="line">  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">2</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>])),</span><br><span class="line">  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;world&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将两条消息拼接在一起发送</span></span><br><span class="line">client.<span class="title function_">write</span>(<span class="title class_">Buffer</span>.<span class="title function_">concat</span>([hello, world]));</span><br><span class="line"></span><br><span class="line"><span class="comment">// node client.js 执行脚本</span></span><br></pre></td></tr></table></figure>

<p>可以看到 server 端：</p>
<p><img src="/images/tcp/code.png" alt="code.png"></p>
<p>虽然 client 将两条消息拼接在一起发送，server 还是成功的解析了消息。</p>
<h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><p>前面的例子其实已经实现了一个简易的 RPC 系统。所有应用层的协议都是类似的原理，约定一套<strong>编码</strong>规则，然后对不同种类的消息做不同的处理。</p>
<p>同时，不要忽略的是：TCP 是全双工长链接。server 和 client 之间可以保持连接，并且有来有回的发送很多条消息，除非一方主动或者由于故障断开连接。</p>
<p>DNS、路由器、网卡、CPU 这些硬件付出了巨大的努力才建立一条链接，而 HTTP&#x2F;1.0 却只用来发送一条请求&#x2F;响应消息就断开了它，这是多么巨大的资源浪费！</p>
<p>随着万维网的发展，http 1.0 逐渐暴露了网络性能低下的缺陷，包括链接利用率太低、消息头太大，才有了后面的 http 1.1 和 http&#x2F;2。</p>
<p>我们接下来看看最简单的 http 1.x 协议是如何实现的，核心依然是消息的编码。</p>
<p>非严谨举例。请求报文格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;method&gt; &lt;url&gt; HTTP/1.1</span><br><span class="line">&lt;header-field&gt;: &lt;header-value&gt;</span><br><span class="line"></span><br><span class="line">&lt;request body&gt;</span><br></pre></td></tr></table></figure>

<p>响应报文格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 122</span><br><span class="line">&lt;header-field&gt;: &lt;header-value&gt;</span><br><span class="line"></span><br><span class="line">&lt;response body&gt;</span><br></pre></td></tr></table></figure>

<p>为了方便理解，改用 js 实现一个简单的 http server：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> delimiter = <span class="string">&#x27;\r\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = net.<span class="title function_">createServer</span>(<span class="function">(<span class="params">conn</span>) =&gt;</span> &#123;</span><br><span class="line">  conn.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> method = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">let</span> url = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">let</span> protocol = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> headers = &#123;&#125;;</span><br><span class="line">  <span class="keyword">let</span> body = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">let</span> methodParsed = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> inBody = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">sendResponse</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`method: <span class="subst">$&#123;method&#125;</span>, url: <span class="subst">$&#123;url&#125;</span>, protocol: <span class="subst">$&#123;protocol&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`headers: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(headers, <span class="literal">undefined</span>, <span class="number">2</span>)&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`body: <span class="subst">$&#123;body&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> resBody = <span class="string">`&lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;Hello HTTP&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">  &lt;h1&gt;Hello HTTP&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> res = [</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;protocol&#125;</span> 200 OK`</span>,</span><br><span class="line">      <span class="string">`Content-Type: text/html`</span>,</span><br><span class="line">      <span class="string">`Content-Length: <span class="subst">$&#123;resBody.length&#125;</span>`</span>,</span><br><span class="line">      delimiter,</span><br><span class="line">      resBody</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    conn.<span class="title function_">write</span>(res.<span class="title function_">join</span>(delimiter));</span><br><span class="line">    conn.<span class="title function_">end</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">isRequestEnd</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> body.<span class="property">length</span> &gt;= (headers[<span class="string">&#x27;Content-Length&#x27;</span>] || <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  conn.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">    data += chunk;</span><br><span class="line">    <span class="keyword">if</span> (inBody) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isRequestEnd</span>()) &#123;</span><br><span class="line">        <span class="title function_">sendResponse</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (data.<span class="title function_">substr</span>(i, <span class="number">2</span>) === delimiter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="title function_">substr</span>(i + <span class="number">2</span>, <span class="number">2</span>) === delimiter) &#123;</span><br><span class="line">          inBody = <span class="literal">true</span>;</span><br><span class="line">          data = data.<span class="title function_">slice</span>(i + <span class="number">4</span>);</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isRequestEnd</span>()) &#123;</span><br><span class="line">            <span class="title function_">sendResponse</span>();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> line = data.<span class="title function_">slice</span>(<span class="number">0</span>, i);</span><br><span class="line">        <span class="keyword">if</span> (methodParsed) &#123;</span><br><span class="line">          <span class="keyword">const</span> [key, value] = line.<span class="title function_">split</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">          headers[key] = value;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`header: <span class="subst">$&#123;key&#125;</span> <span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          [method, url, protocol] = line.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">          methodParsed = <span class="literal">true</span>;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`method: <span class="subst">$&#123;method&#125;</span>, url: <span class="subst">$&#123;url&#125;</span>, protocol: <span class="subst">$&#123;protocol&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        data = data.<span class="title function_">slice</span>(i + <span class="number">2</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure>

<p>打开浏览器访问 <code>http://localhost:8888</code> 可以看到 HTML 页面。</p>
<p>从上面的代码可以看到，HTTP 报文头部的 <code>Content-Length</code> 字段说明了请求&#x2F;响应体的字节长度，和我们前面的简单消息编码类似。</p>
<p>http 的请求体和响应体也是一串字节，但是在收到这些字节应该如何解析呢？</p>
<p>答案是由报文头部的 <code>Content-Type</code> 说明这些字节应该如何解码，常见的有 <code>application/json</code> 和 <code>multipart/form-data</code> 等。这些类型可以告诉接收方应该如何解析这些字节。</p>
<h3 id="HTTP-x2F-2"><a href="#HTTP-x2F-2" class="headerlink" title="HTTP&#x2F;2"></a>HTTP&#x2F;2</h3><p><a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/performance/http2?hl=zh-cn">HTTP&#x2F;2</a> 于 2015 年发布，主要是基于 Google 的 SPDY 协议。</p>
<p>针对 HTTP 1.x 的改进如下：</p>
<ol>
<li>二进制传输。包体积更小，效率更高。</li>
<li>多路复用。同一条 TCP 链接可以处理多个请求响应。</li>
<li>Header 压缩。减少每次请求的 header 大小，提高带宽利用率。</li>
</ol>
<p>可以看到，HTTP&#x2F;2 的以上特点都是针对 HTTP 1.x 的缺点进行的改进。在理解了 TCP 的原理之后，我们能更容易的理解这些改进，因为从一个高效的通信系统的角度来看，HTTP 1.x 的缺点实在太明显了。</p>
<h3 id="HTTP-x2F-3"><a href="#HTTP-x2F-3" class="headerlink" title="HTTP&#x2F;3"></a>HTTP&#x2F;3</h3><p>HTTP&#x2F;3 主要是基于 Google 的 <a target="_blank" rel="noopener" href="https://www.chromium.org/quic">Quic</a> 协议，将底层的 TCP 换成了 UDP。</p>
<p>原因是 TCP 为了保证可靠传输，在性能上做了很多妥协，比如每一个数据包的 ACK。而 socket 都被集成到了各大操作系统的内核，内核的更新是比较慢的。</p>
<p>而且由于现在的网络稳定性和带宽相比 20 年前有了很大的改善，Google 决定在 UDP 的基础上增加安全性校验和可靠性算法，推出了 Quic 协议，目的是兼具高效和可靠。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/tcp/" data-id="cl2ef05lo000a8mmtbojpez6j" data-title="从 TCP 说起" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-vite" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/vite/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:34:05.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/vite/">vite 为什么快</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="vite-为什么快？"><a href="#vite-为什么快？" class="headerlink" title="vite 为什么快？"></a>vite 为什么快？</h1><p>vite 将 html 文件看作是项目入口文件，在 html 里通过 <code>&lt;script type=&quot;module&quot;&gt;</code> 使用 ECMAScript 原生的 <code>import</code> 向开发服务器请求依赖，没有被请求的依赖不会处理，这样就不需要像 webpack 打包整个项目。在巨型前端项目中，这种方式的效率有质的提升。</p>
<blockquote>
<p>vite 的简版原型可以参考 <a target="_blank" rel="noopener" href="https://github.com/preactjs/wmr">https://github.com/preactjs/wmr</a></p>
</blockquote>
<p>本文将针对 vite 开发时的 server 机制进行说明。</p>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p>举个简单的例子，index.html 的源码内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vite App<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注意，这里用 url 的方式引入 main.tsx --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/src/main.tsx&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动 vite server 之后，返回给浏览器的 html 如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/@vite/client&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// /@react-refresh 会被 react-refresh 插件处理，实际是 react-refresh/cjs/react-refresh-runtime.development.js 的代码</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">import</span> <span class="title class_">RefreshRuntime</span> <span class="keyword">from</span> <span class="string">&#x27;/@react-refresh&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="title class_">RefreshRuntime</span>.<span class="title function_">injectIntoGlobalHook</span>(<span class="variable language_">window</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">window</span>.<span class="property">$RefreshReg$</span> = <span class="function">() =&gt;</span> &#123;&#125;;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">window</span>.<span class="property">$RefreshSig$</span> = <span class="function">() =&gt;</span> <span class="function">(<span class="params">type</span>) =&gt;</span> type;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">window</span>.<span class="property">__vite_plugin_react_preamble_installed__</span> = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vite App<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/src/main.tsx&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，vite 向 html 的 head 前面插入了两个 script：</p>
<ul>
<li>&#x2F;@vite&#x2F;client 用来和 vite websocket server 通信，进行热更新</li>
<li>&#x2F;@react-refresh 用来更新 React 组件</li>
</ul>
<p>后面会详细讲到这两个脚本的作用，现在我们继续向下看。</p>
<p>浏览器接下来就会向开发服务器请求 &#x2F;src&#x2F;main.tsx，&#x2F;src&#x2F;main.tsx 的源码如下：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.tsx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.less&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>vite 会对 main.tsx 文件进行处理，返回给浏览器的实际内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;/node_modules/.vite/react.js?v=9a3efe6b&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;/node_modules/.vite/react-dom.js?v=9a3efe6b&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;/src/App.tsx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;/src/index.less&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="title class_">App</span>), <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>可以看到 vite 对 tsx 文件进行了一些“简单”的处理（依赖的地址替换成 url）就返回给浏览器了，并没有打包整个 js 代码。</p>
<p>浏览器收到 main.tsx 之后，又会请求 &#x2F;src&#x2F;index.less，index.less 源码如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@color:</span> red;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="variable">@color</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么浏览器收到的 less 文件内容是什么呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createHotContext <span class="keyword">as</span> __vite__createHotContext &#125; <span class="keyword">from</span> <span class="string">&#x27;/@vite/client&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">hot</span> = <span class="title function_">__vite__createHotContext</span>(<span class="string">&#x27;/src/index.less&#x27;</span>);</span><br><span class="line"><span class="keyword">import</span> &#123; updateStyle, removeStyle &#125; <span class="keyword">from</span> <span class="string">&#x27;/@vite/client&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> id = <span class="string">&#x27;/Users/june/Workspace/vite-demo/src/index.less&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> css = <span class="string">&#x27;body &#123;\n  margin: 0;\n  color: red;\n&#125;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">updateStyle</span>(id, css);</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">hot</span>.<span class="title function_">accept</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> css;</span><br><span class="line"><span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">hot</span>.<span class="title function_">prune</span>(<span class="function">() =&gt;</span> <span class="title function_">removeStyle</span>(id));</span><br></pre></td></tr></table></figure>

<p>为了实现热更新，less 文件的内容会作为 javascript（css 文件也是一样的返回结果）返回给浏览器。</p>
<p>这里说明一下，浏览器请求一个 url 的时候，是不知道 url 背后的资源类型的，只有从服务器的响应头的 <code>Content-Type</code> 字段才知道类型。</p>
<h2 id="plugin"><a href="#plugin" class="headerlink" title="plugin"></a>plugin</h2><p>在说明 vite 对 tsx 和 less 如何处理之前，需要先了解 vite server 的架构。</p>
<p>vite server 的核心是一个名为 <code>pluginContainer</code> 的实例，pluginContainer 可以流水线式的调用注册的插件对 url 进行处理，最终返回内容给浏览器。</p>
<p>这些 plugin 也就是 vite plugin，兼容 rollup plugin，主要有以下方法：</p>
<blockquote>
<p>rollup plugin 的文档可以参考 <a target="_blank" rel="noopener" href="https://rollupjs.org/guide/en/#plugin-development">https://rollupjs.org/guide/en/#plugin-development</a></p>
</blockquote>
<ul>
<li>resolveId(importee: string, importer: string): { id: string, external: boolean }</li>
</ul>
<p>该方法用来查询 import 路径的真实地址，比如计算各种 alias mainFields extensions，查询最终文件地址。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// foo.js</span></span><br><span class="line"><span class="comment">// importer 是 foo.js</span></span><br><span class="line"><span class="comment">// importee 是 bar</span></span><br><span class="line"><span class="comment">// bar 的最终 resolve 结果可能是 node_modules/bar/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Bar</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;bar&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>load(id: string): { code: string, map?: string }</li>
</ul>
<p>该方法用来加载指定的资源，返回资源内容.</p>
<ul>
<li>transform(code: string, id: string): { code: string, map?: string }</li>
</ul>
<p>该方法用来对资源内容进行处理，比如将 tsx 编译成 js，修改代码中 import from 的路径。</p>
<h3 id="vite-的-plugins"><a href="#vite-的-plugins" class="headerlink" title="vite 的 plugins"></a>vite 的 plugins</h3><p>vite 主要有以下 plugins</p>
<ul>
<li>vite:pre-alias 尝试直接加载 prebundle 的结果，下文会讲到什么是 prebundle</li>
<li>alias 其实就是 @rollup&#x2F;plugin-alias，各种 alias 重定向</li>
<li>react-refresh 该插件源自 @vitejs&#x2F;plugin-react-refresh 包，在 jsx&#x2F;tsx 的编译结果前后添加 react-refresh 库代码及热更新代码</li>
<li>vite:resolve 查询 npm 包指向的最终文件路径，包括 require 算法，extensions、browser 等规则。请谨慎阅读源码，否则会产生头晕恶心想吐等症状</li>
<li><strong>vite:css</strong> 编译 less&#x2F;sass&#x2F;stylus 为 css 代码，转换代码中的 url 等资源路径，处理 css modules 等</li>
<li><strong>vite:esbuild</strong> 将 ts&#x2F;tsx&#x2F;jsx 转换为 js</li>
<li>vite:json 读取 json 文件内容，转换为 esm 格式的 js 内容</li>
<li>vite:define 替换 process.env.NODE_ENV 等环境变量</li>
<li>vite:css-post 将 css 代码添加 updateStyle 等方法，转换为 js 代码</li>
<li>vite:client-inject 转换 &#x2F;@vite&#x2F;client 的代码，注入 websocket 的 host port 等变量，实现热更新</li>
<li><strong>vite:import-analysis</strong> 将依赖路径转换为 url</li>
</ul>
<h2 id="tsx-文件"><a href="#tsx-文件" class="headerlink" title="tsx 文件"></a>tsx 文件</h2><p>那么 vite 对 main.tsx 做了哪些处理呢？</p>
<p>主要有以下几点：</p>
<ul>
<li>npm 包预编译，存储到缓存目录</li>
<li>将依赖路径转换为 url</li>
<li>tsx 编译成 js</li>
</ul>
<p>下面分别讲解：</p>
<h2 id="npm-依赖"><a href="#npm-依赖" class="headerlink" title="npm 依赖"></a>npm 依赖</h2><p>类似 <code>import &#123; someMethod &#125; from &#39;some_dep&#39;;</code> 在浏览器中会报错，因为浏览器只能识别 URL，无法识别 npm 包。</p>
<p>那么 vite 是怎么处理 npm 包的呢？</p>
<p>vite 首先用 esbuild 从入口文件找到所有的 npm 包进行预处理，然后将产物存储到 <code>node_modules/.vite</code> 目录下，这个过程称为 prebundle，在 server 启动前执行。</p>
<blockquote>
<p>prebundle 的调用在 packages&#x2F;vite&#x2F;src&#x2F;node&#x2F;server&#x2F;index.ts 的 runOptimize 方法</p>
</blockquote>
<p>预处理的过程是提供了 esbuild 的插件，插件的 onResolve 钩子（类似 rollup）找到依赖，如果依赖的路径含有 node_modules 或者指定的配置，就记录下来。</p>
<p>再使用 esbuild 将记录的依赖列表打包，产出为 ESM 格式，并存储到 <code>node_modules/.vite</code> 目录下，最后生成一份 meta 信息，包括依赖 id 和 build 产物的映射。</p>
<p>import-analysis 插件再将代码中的 some_dep 重写成类似 <code>/node_modules/.vite/some_dep.js?v=deiejgk</code>，这样就是一个合法的 URL 了。</p>
<h2 id="依赖路径替换"><a href="#依赖路径替换" class="headerlink" title="依赖路径替换"></a>依赖路径替换</h2><p>vite 使用 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/es-module-lexer">es-module-lexer</a> 分析代码（经过 esbuild 编译后的 ESM）中的依赖，并进行路径替换。</p>
<p>需要注意：vite 不支持类似 webpack 的 <code>import(</code>.&#x2F;hello&#x2F;${lang}.json<code>)</code> 表达式</p>
<h2 id="less-文件"><a href="#less-文件" class="headerlink" title="less 文件"></a>less 文件</h2><p>vite 会先将 less 文件编译成 css 代码，再用 postcss 替换 <code>@import</code> 和 <code>url()</code> 的路径。</p>
<p>如果 less 文件的后缀名是 <code>.modudle.less</code>，还会使用 <a target="_blank" rel="noopener" href="https://github.com/madyankin/postcss-modules">postcss-modules</a> 来生成 css module 的 class 名称，并将名称的映射关系 JSON 作为 default 导出。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.module.less 源码</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.App</span> &#123;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回给浏览器的内容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> css = <span class="string">&#x27;._App_dwiay_1 &#123;\n  text-align: center;\n&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">App</span> = <span class="string">&#x27;_App_dwiay_1&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title class_">App</span>: <span class="title class_">App</span>,</span><br><span class="line">  <span class="string">&#x27;App-logo&#x27;</span>: <span class="string">&#x27;_App-logo_dwiay_4&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;App-logo-spin&#x27;</span>: <span class="string">&#x27;_App-logo-spin_dwiay_1&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;App-header&#x27;</span>: <span class="string">&#x27;_App-header_dwiay_13&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;App-link&#x27;</span>: <span class="string">&#x27;_App-link_dwiay_23&#x27;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样 js 文件就可以使用 <code>import styles from &#39;/App.module.less&#39;;</code> 再使用 <code>styles.App</code> 了。</p>
<h2 id="react-refresh"><a href="#react-refresh" class="headerlink" title="react-refresh"></a>react-refresh</h2><p>react-refresh 插件 使用 babel&#x2F;core 及相关插件编译 tsx&#x2F;jsx，添加 react 官方的热更新代码，代码片段如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 就是返回 react-refresh npm 包的内容，并转换为 ESM 的形式</span></span><br><span class="line"><span class="comment">// 这里用了巧妙的方式将 commonjs 转换为 ESM，即在模块内定义名为 exports 的变量，再拼接代码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">load</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (id === <span class="string">&#x27;/@react-refresh&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">const exports = &#123;&#125;;</span></span><br><span class="line"><span class="string"><span class="subst">$&#123;fs.readFileSync(</span></span></span><br><span class="line"><span class="subst"><span class="string">  <span class="built_in">require</span>.resolve(<span class="string">&#x27;react-refresh/cjs/react-refresh-runtime.development.js&#x27;</span>),</span></span></span><br><span class="line"><span class="subst"><span class="string">  <span class="string">&#x27;utf-8&#x27;</span></span></span></span><br><span class="line"><span class="subst"><span class="string">)&#125;</span></span></span><br><span class="line"><span class="string">export default exports</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 babel 处理代码，添加 react 官方的热更新代码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transform</span>(<span class="params">code, id</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> parserPlugins = [</span><br><span class="line">    <span class="string">&#x27;jsx&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;importMeta&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;topLevelAwait&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;classProperties&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;classPrivateProperties&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;classPrivateMethods&#x27;</span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/\.tsx?$/</span>.<span class="title function_">test</span>(id)) &#123;</span><br><span class="line">    parserPlugins.<span class="title function_">push</span>(<span class="string">&#x27;typescript&#x27;</span>, <span class="string">&#x27;decorators-legacy&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// result 是编译后的代码</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">transformSync</span>(code, &#123;</span><br><span class="line">    <span class="attr">babelrc</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">configFile</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">filename</span>: id,</span><br><span class="line">    <span class="attr">parserOpts</span>: &#123;</span><br><span class="line">      <span class="attr">sourceType</span>: <span class="string">&#x27;module&#x27;</span>,</span><br><span class="line">      <span class="attr">allowAwaitOutsideFunction</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">plugins</span>: parserPlugins</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">generatorOpts</span>: &#123;</span><br><span class="line">      <span class="attr">decoratorsBeforeExport</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">      <span class="comment">// &lt;sometag /&gt; 编译成 &lt;sometag __self=&#123;this&#125; /&gt;</span></span><br><span class="line">      <span class="built_in">require</span>(<span class="string">&#x27;@babel/plugin-transform-react-jsx-self&#x27;</span>),</span><br><span class="line">      <span class="comment">// &lt;sometag /&gt; 编译成 &lt;sometag __source=&#123; &#123; fileName: &#x27;this/file.js&#x27;, lineNumber: 10, columnNumber: 1 &#125; &#125; /&gt;</span></span><br><span class="line">      <span class="built_in">require</span>(<span class="string">&#x27;@babel/plugin-transform-react-jsx-source&#x27;</span>),</span><br><span class="line">      <span class="comment">// https://github.com/facebook/react/blob/main/packages/react-refresh/src/ReactFreshBabelPlugin.js</span></span><br><span class="line">      [<span class="built_in">require</span>(<span class="string">&#x27;react-refresh/babel&#x27;</span>), &#123; <span class="attr">skipEnvCheck</span>: <span class="literal">true</span> &#125;]</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">ast</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">sourceMaps</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">sourceFileName</span>: id</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="HMR"><a href="#HMR" class="headerlink" title="HMR"></a>HMR</h2><p><code>/@vite/client</code> 加载之后会和 vite server 建立长链接，监听处理 server 推送的消息（当 watcher 监听到文件变化时向 vite server 推送变动文件的信息），主要有以下类型：</p>
<ul>
<li><p>update<br>消息 payload 是一组更新信息，如果是 js-update 会重新请求 js 文件。如果是 css-update 则会更新 link 链接。</p>
</li>
<li><p>full-reload<br>调用 location.reload 刷新页面。当 html 页面更新，或者是依赖图的入口资源更新（&#x2F;src&#x2F;main.tsx）更新时会触发该事件。</p>
</li>
<li><p>prune<br>清除资源，比如删掉 link 标签。假设 A 文件变动，经过对比发现 A 文件不再引入 B 资源，而且 B 资源不再被所有资源引用，则触发该事件清理 B 资源。</p>
</li>
</ul>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>可以看到 vite 的思路还是比较简单的，大部分的代码都是在处理很脏的逻辑，比如 commonjs 和 esm 的转换，资源的 resolve 等。</p>
<p>vite 的实现充分利用了社区资源：rollup esbuild babel es-module-lexer postcss，将这些工具应用在合适的场景。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/vite/" data-id="cl2ef05lt000g8mmt3f84082b" data-title="vite 为什么快" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vitejs-vite/" rel="tag">vitejs,vite</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-this" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/this/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:33:26.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/this/">不一样的 this 问题</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="不一样的-this-问题"><a href="#不一样的-this-问题" class="headerlink" title="不一样的 this 问题"></a>不一样的 this 问题</h1><p>JS 的 this 指向问题是老生常谈的难点了。我当初从 Java 转过来时极其不适应，花了好长时间才摆脱这个阴影。网上也有很多关于 this 的文章了，本文就简单说说，再聊点不一样的。</p>
<h5 id="this-主要是在函数中使用，在函数外使用的话，一律指向全局对象"><a href="#this-主要是在函数中使用，在函数外使用的话，一律指向全局对象" class="headerlink" title="this 主要是在函数中使用，在函数外使用的话，一律指向全局对象"></a>this 主要是在函数中使用，在函数外使用的话，一律指向全局对象</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">console.log(this)    // window</span><br><span class="line"></span><br><span class="line">var o = &#123;</span><br><span class="line">  global: this       // window</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="在函数内使用-this-时，具体指向是由函数的调用方式决定，而不是根据函数定义方式决定"><a href="#在函数内使用-this-时，具体指向是由函数的调用方式决定，而不是根据函数定义方式决定" class="headerlink" title="在函数内使用 this 时，具体指向是由函数的调用方式决定，而不是根据函数定义方式决定"></a>在函数内使用 this 时，具体指向是由函数的调用方式决定，而不是根据函数定义方式决定</h4><h5 id="1-函数作为普通函数运行时，可以看做是当做全局对象的方法运行，此时-this-指向全局对象"><a href="#1-函数作为普通函数运行时，可以看做是当做全局对象的方法运行，此时-this-指向全局对象" class="headerlink" title="1. 函数作为普通函数运行时，可以看做是当做全局对象的方法运行，此时 this 指向全局对象"></a>1. 函数作为普通函数运行时，可以看做是当做全局对象的方法运行，此时 this 指向全局对象</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function hello() &#123;</span><br><span class="line">  console.log(this)</span><br><span class="line">&#125;</span><br><span class="line">hello()    // window 作为普通函数运行</span><br></pre></td></tr></table></figure>

<h5 id="2-函数作为对象的方法调用时，函数内的-this-指向该对象"><a href="#2-函数作为对象的方法调用时，函数内的-this-指向该对象" class="headerlink" title="2. 函数作为对象的方法调用时，函数内的 this 指向该对象"></a>2. 函数作为对象的方法调用时，函数内的 this 指向该对象</h5><p>所以上面一条，普通函数可以看做是全局对象的方法，所以 this 指向全局对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var name = &#x27;global&#x27;</span><br><span class="line"></span><br><span class="line">var obj = &#123;</span><br><span class="line">  name: &#x27;local&#x27;,</span><br><span class="line">  getName: function () &#123;</span><br><span class="line">    console.log(this.name)</span><br><span class="line">  &#125;,</span><br><span class="line">  outer: function () &#123;</span><br><span class="line">    function inner() &#123;</span><br><span class="line">      console.log(this.name)</span><br><span class="line">    &#125;</span><br><span class="line">    inner()      // 这是第 12 行代码</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">obj.getName()    // local 作为 obj 的方法调用，此时 this 指向 obj</span><br><span class="line">obj.outer()      // 打印什么？控制台试试吧</span><br></pre></td></tr></table></figure>

<p>这里提到了一个大家容易忽视的点: <code>嵌套函数</code><br>还记得上面标题说的吗？ this 的指向是由函数的调用方式来决定的</p>
<p>由于大多数嵌套函数是直接被调用的, 比如：第 12 行代码，调用 inner()<br><code>这时 inner 是被当做普通函数调用的</code>，也可以看做是 window.inner() ，所以此时 inner 内部的 this 指向 window，打印 global</p>
<p>常见的解决方案如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">var obj = &#123;</span><br><span class="line">  name: &#x27;local&#x27;,</span><br><span class="line">  outer: function () &#123;</span><br><span class="line">    var that = this</span><br><span class="line">    function inner() &#123;</span><br><span class="line">      console.log(that.name)</span><br><span class="line">    &#125;</span><br><span class="line">    inner()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 声明变量 that ，在 inner 内部用 that 代替 this</span><br><span class="line">obj.outer()    // local</span><br></pre></td></tr></table></figure>

<p>还有个问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var name = &#x27;global&#x27;</span><br><span class="line">var obj = &#123;</span><br><span class="line">  name: &#x27;local&#x27;,</span><br><span class="line">  getName: function () &#123;</span><br><span class="line">    console.log(this.name)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">obj.getName()    // local</span><br><span class="line">var getName = obj.getName</span><br><span class="line">getName()     // ?</span><br></pre></td></tr></table></figure>

<p>直接调用 getName() 会打印 global<br>还是前面说的，虽然 obj.getName() 在声明的时候是作为 obj 的方法<br>但是把它赋值给 getName， 再调用 getName() 和 obj.getName() 的调用方式已经不同了</p>
<h5 id="3-apply-call-bind-改变-this-指向"><a href="#3-apply-call-bind-改变-this-指向" class="headerlink" title="3. apply call bind 改变 this 指向"></a>3. apply call bind 改变 this 指向</h5><p>这个没啥还说的，强制改变 this 的指向，bind 的优先级最高。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">var name = &#x27;global&#x27;</span><br><span class="line">var obj = &#123;</span><br><span class="line">  name: &#x27;local&#x27;,</span><br><span class="line">  getName: function () &#123;</span><br><span class="line">    console.log(this.name)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj2 = &#123;</span><br><span class="line">  name: &#x27;xiaoming&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj3 = &#123;</span><br><span class="line">  name: &#x27;laowang&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">obj.getName()     // local</span><br><span class="line">obj.getName.call(obj2)    // xiaoming</span><br><span class="line"></span><br><span class="line">var getName = obj.getName.bind(obj3)    // 将 getName 内部的 this 绑定到 obj3</span><br><span class="line">getName()     // laowang 不再是 window</span><br><span class="line"></span><br><span class="line">getName.call(obj2)    // laowang</span><br><span class="line">                      // bind 不会受到 apply 和 call 影响</span><br></pre></td></tr></table></figure>

<h5 id="4-定时器设置的函数，this-会指向全局"><a href="#4-定时器设置的函数，this-会指向全局" class="headerlink" title="4. 定时器设置的函数，this 会指向全局"></a>4. 定时器设置的函数，this 会指向全局</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var name = &#x27;global&#x27;</span><br><span class="line">var obj = &#123;</span><br><span class="line">  name: &#x27;local&#x27;,</span><br><span class="line">  getName: function () &#123;</span><br><span class="line">    console.log(this.name)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj3 = &#123;</span><br><span class="line">  name: &#x27;laowang&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setTimeout(obj.getName, 1000)            // global</span><br><span class="line">setTimeout(obj.getName.bind(obj3), 2000) // laowang</span><br></pre></td></tr></table></figure>

<p>bind 强制绑定优先级最高，不受定时器影响<br>正确调用方式如下：<br>外面包一层匿名函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(function () &#123;</span><br><span class="line">  obj.getName()</span><br><span class="line">&#125;, 1000)            // local</span><br></pre></td></tr></table></figure>

<h5 id="5-ES6-箭头函数"><a href="#5-ES6-箭头函数" class="headerlink" title="5. ES6 箭头函数"></a>5. ES6 箭头函数</h5><p>ES6 推出了箭头函数，详细教程可以参考<a target="_blank" rel="noopener" href="http://es6.ruanyifeng.com/#docs/function#%E7%AE%AD%E5%A4%B4%E5%87%BD%E6%95%B0">阮一峰老师的教程</a><br><code>箭头函数没有自己的 this 和 arguments</code>， 因此在箭头函数内部使用 this 和 argments， 其实使用的是外层的 this 和 arguments</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var name = &#x27;global&#x27;</span><br><span class="line">var obj = &#123;</span><br><span class="line">  name: &#x27;local&#x27;,</span><br><span class="line">  getName: () =&gt; console.log(this.name),</span><br><span class="line">  outer: function () &#123;</span><br><span class="line">    var inner = () =&gt; console.log(this.name)</span><br><span class="line">    inner()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">obj.getName()    // global 由于箭头函数没有自己的 this，所以 getName 内部的 this 其实是函数外部的 this，指向全局</span><br><span class="line">obj.outer()      // local</span><br></pre></td></tr></table></figure>

<p>作为函数的方法，最好不要用箭头函数，因为箭头函数内部的 this 不再指向该对象。<br>所以箭头函数虽然好用，但是不要滥用哦</p>
<p>箭头函数还常用于数组的 forEach&#x2F;map&#x2F;some&#x2F;every&#x2F;filter&#x2F;reduce 等循环方法中，比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var arr = [1, 2, 3].map(item =&gt; item * 2)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/this/" data-id="cl2ef05lq000c8mmt1ig54jlw" data-title="不一样的 this 问题" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js-this/" rel="tag">js,this</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-viewport" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/04/19/viewport/" class="article-date">
  <time class="dt-published" datetime="2018-04-19T12:32:17.000Z" itemprop="datePublished">2018-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/04/19/viewport/">移动端 H5 viewport</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="移动端-H5-viewport"><a href="#移动端-H5-viewport" class="headerlink" title="移动端 H5 viewport"></a>移动端 H5 viewport</h1><p>移动端页面大家都遇到过 viewport 的问题。关于 viewport 的文章有很多了，推荐给大家这两篇，写得非常详细。<br><a target="_blank" rel="noopener" href="https://github.com/riskers/blog/issues/17">移动端适配方案(上)</a><br><a target="_blank" rel="noopener" href="https://github.com/riskers/blog/issues/18">移动端适配方案(下)</a></p>
<p>本文对 viewport 做一些补充</p>
<h3 id="手机屏幕"><a href="#手机屏幕" class="headerlink" title="手机屏幕"></a>手机屏幕</h3><p>手机屏幕属于硬件属性，我们无论是通过 JS 还是 meta 标签都是无法影响到它的。</p>
<ul>
<li>手机屏幕物理像素，也就是手机厂商们说的像素、分辨率、PPI 这些。</li>
</ul>
<p>安卓常见的有 720X1280 , 1080X1920 等等<br>iPhone 则是 iPhone5 640X1136，iPhone6 750X1334，iPhone6P 1080X1920</p>
<ul>
<li>手机屏幕逻辑像素，物理像素经过折算之后的像素数。也就是<strong>理想视口</strong>的尺寸</li>
</ul>
<p>iPhone5 屏幕本来是 640px 宽，但是折算成了 <strong>320px</strong><br>iPhone6 物理像素 750px 款，折算成 <strong>375px</strong><br>iPhone6P 略微奇葩一点，物理像素实际 1080px 宽，但是系统向外暴露的确是 1242px，再折算成了 <strong>414px</strong></p>
<p><code>screen.width/height</code> 可以获取屏幕的逻辑像素</p>
<h3 id="布局视口-layout-viewport"><a href="#布局视口-layout-viewport" class="headerlink" title="布局视口 layout viewport"></a>布局视口 layout viewport</h3><p>刚才讲过的屏幕物理像素和逻辑像素，这些都是手机厂商设置好的，我们是无法设置的，重点再与接下来的两个视口，大家千万别混淆了。</p>
<p>layout viewport 相当于浏览器的宽度。<br>我们是可以通过 <meta name="viewport" content="width=XXX">设置的。<br>默认情况下，layout viewport 一般为 980px 宽。</p>
<p><code>document.documentElement.clientWidth</code> 可以获取 layout viewport 的宽度。</p>
<h3 id="视觉视口-visual-viewport"><a href="#视觉视口-visual-viewport" class="headerlink" title="视觉视口 visual viewport"></a>视觉视口 visual viewport</h3><p>视觉视口可以看作是手机屏幕这么大的一个窗口，但是它能显示的像素个数却不是屏幕上面的这么多逻辑像素。</p>
<p>视觉视口不太容易理解，虽然手机屏幕的逻辑像素已经固定了，比如 iPhone5 是 320px。</p>
<p>但是屏幕这 320px 宽，却可以显示 980px 宽的内容，所以视觉窗口的宽度是 980px。<br>很多没有对移动端做适配的网页，我们用手机打开，发现网页被缩小到手机屏幕这么宽了。</p>
<p>重点就在于缩放，缩放让 320px 的屏幕能显示更多内容了。<br><code>window.innerWidth</code> 可以获取 visual viewport 的宽度。</p>
<p>通过 <meta name="viewport" content="initial-scale=x"> 可以设置 visual viewport 的宽度。<br>visual viewport 的宽度为 <code>screen.width / initial-scale</code><br>同时，也会影响到 布局视口 的宽度，因为布局视口的宽度始终大于等于 visual layout 的宽度。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果不设置 initial-scale ，iOS设备会自动将 visual viewport 缩放到 布局视口一样大。</span><br></pre></td></tr></table></figure>

<p>还记得默认的 布局视口 是多宽吗？</p>
<h3 id="屏幕逻辑像素、布局视口、视觉视口-三者的关系"><a href="#屏幕逻辑像素、布局视口、视觉视口-三者的关系" class="headerlink" title="屏幕逻辑像素、布局视口、视觉视口 三者的关系"></a>屏幕逻辑像素、布局视口、视觉视口 三者的关系</h3><meta name="viewport" content="width=device-width">

<p>将 layout viewport 的宽度设置为 屏幕宽</p>
<meta name="viewport" content="width=640">

<p>将 layout viewport 宽度设置为 640px （逻辑像素，而不是物理像素）</p>
<meta name="viewport" content="initial-scale=0.5">

<p>将 visual viewport 设置为 屏幕宽度的 2 倍（正确的理解是：visual viewport 的 0.5 倍是屏幕宽度，所以 visual viewport 的宽度就是屏幕的 2 倍了）</p>
<p>此时 布局视口的宽度也是 屏幕宽的 2 倍，而不再是默认的 980px 了</p>
<p>总结：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、默认情况下 layout viewport 为 980px</span><br><span class="line">2、width=x 设置布局视口，initial-scale=y 设置视觉视口</span><br><span class="line">3、如果只设置 布局视口 和 视觉视口 中的一个，那么另一个也是同样的宽度</span><br><span class="line">4、布局视口 的宽度始终大于等于 视觉视口</span><br></pre></td></tr></table></figure>

<p>举例 iPhone 5 上面</p>
<meta name="viewport" content="width=600,initial-scale=0.5">

<p>那么视觉视口和布局视口分别是多宽呢？</p>
<p>最后的最后，终于到了我们耳熟能详的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1.0&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>大家知道这是什么意思了吧。<br>layout viewport 浏览器窗口，设置为屏幕宽度。<br>visual viewport 也设置为屏幕宽度，不缩放，屏幕有多宽，就显示多少像素。<br>也就是所谓的完美视口。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2018/04/19/viewport/" data-id="cl2ef05ls000e8mmte8iu8m9u" data-title="移动端 H5 viewport" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/viewport/" rel="tag">viewport</a></li></ul>

    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/chrome-extensions/" rel="tag">chrome,extensions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/event-passive/" rel="tag">event,passive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/forever/" rel="tag">forever</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js-this/" rel="tag">js,this</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/json-schema/" rel="tag">json,schema</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/viewport/" rel="tag">viewport</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vitejs-vite/" rel="tag">vitejs,vite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/chrome-extensions/" style="font-size: 10px;">chrome,extensions</a> <a href="/tags/event-passive/" style="font-size: 10px;">event,passive</a> <a href="/tags/forever/" style="font-size: 10px;">forever</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/js-this/" style="font-size: 10px;">js,this</a> <a href="/tags/json-schema/" style="font-size: 10px;">json,schema</a> <a href="/tags/tcp/" style="font-size: 10px;">tcp</a> <a href="/tags/viewport/" style="font-size: 10px;">viewport</a> <a href="/tags/vitejs-vite/" style="font-size: 10px;">vitejs,vite</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/04/19/articles/">好文集锦</a>
          </li>
        
          <li>
            <a href="/2022/04/19/chrome_extension/">chrome 插件开发入门</a>
          </li>
        
          <li>
            <a href="/2022/04/19/design_patterns/">设计模式</a>
          </li>
        
          <li>
            <a href="/2022/04/19/forever/">后台运行 NodeJS</a>
          </li>
        
          <li>
            <a href="/2022/04/19/git/">git 常用命令</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 yinjun<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>