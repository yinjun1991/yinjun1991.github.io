<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>从 TCP 说起 | 写好代码</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="本文从应用的角度以简单直白的代码事例，让大家透彻的理解 TCP 以及 HTTP、RPC、websocket 等常见应用协议。 阅读文本需要有基础的 TCP&#x2F;IP 网络模型知识 TCP&#x2F;IP 是互联网的基石，随着通信技术的发展，5G 势必会产生更多样的网络应用，而应用又可能会催生新的网络协议（比如 http2&#x2F;3，webRTC, web 支付）。 作为软件工程师的我们，">
<meta property="og:type" content="article">
<meta property="og:title" content="从 TCP 说起">
<meta property="og:url" content="http://yinjun.github.io/2022/04/19/tcp/index.html">
<meta property="og:site_name" content="写好代码">
<meta property="og:description" content="本文从应用的角度以简单直白的代码事例，让大家透彻的理解 TCP 以及 HTTP、RPC、websocket 等常见应用协议。 阅读文本需要有基础的 TCP&#x2F;IP 网络模型知识 TCP&#x2F;IP 是互联网的基石，随着通信技术的发展，5G 势必会产生更多样的网络应用，而应用又可能会催生新的网络协议（比如 http2&#x2F;3，webRTC, web 支付）。 作为软件工程师的我们，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yinjun.github.io/images/tcp/telnet.png">
<meta property="og:image" content="http://yinjun.github.io/images/tcp/echo.png">
<meta property="og:image" content="http://yinjun.github.io/images/tcp/code.png">
<meta property="article:published_time" content="2022-04-19T12:34:05.000Z">
<meta property="article:modified_time" content="2022-04-25T07:45:15.450Z">
<meta property="article:author" content="yinjun">
<meta property="article:tag" content="tcp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yinjun.github.io/images/tcp/telnet.png">
  
    <link rel="alternate" href="/atom.xml" title="写好代码" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">写好代码</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一个平庸程序员的博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yinjun.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-tcp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/tcp/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T12:34:05.000Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      从 TCP 说起
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本文从应用的角度以简单直白的代码事例，让大家透彻的理解 TCP 以及 HTTP、RPC、websocket 等常见应用协议。</p>
<p><strong>阅读文本需要有基础的 TCP&#x2F;IP 网络模型知识</strong></p>
<p>TCP&#x2F;IP 是互联网的基石，随着通信技术的发展，5G 势必会产生更多样的网络应用，而应用又可能会催生新的网络协议（比如 http2&#x2F;3，webRTC, web 支付）。</p>
<p>作为软件工程师的我们，在面对这些未知挑战时更应该去了解 TCP，它就像是定海神针能够让我们以不变应万变。</p>
<h2 id="TCP-和-socket"><a href="#TCP-和-socket" class="headerlink" title="TCP 和 socket"></a>TCP 和 socket</h2><p><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc793">TCP 协议标准</a>制定于 1981 年，是一个非常复杂的协议，包括了可靠性保证（握手&#x2F;挥手、ACK 确认）、拥塞控制算法（滑动窗口、慢启动）等内容。</p>
<p>1983 年 Berkeley 在 BSD4.2 系统中发布了 <code>Berkeley sockets API</code>（下文简称 socket） 作为 TCP 的代码实现，之后 socket 被移植到 windows linux 等众多操作系统中。可以说目前我们使用的网络编程技术几乎全部基于 socket。</p>
<p>总结一下：TCP 是非常复杂的协议，socket 是 TCP 的一种代码实现。</p>
<p>下面是一段 socket 代码，我们看看最原始的网络编程是怎样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* 1. 创建 socket</span></span><br><span class="line"><span class="comment">   * AF_INET 表示用于创建 IPv4 网络的 socket</span></span><br><span class="line"><span class="comment">   * SOCK_STREAM 表示用于 TCP 网络（还可以使用 SOCK_DGRAM 创建 UDP socket）</span></span><br><span class="line"><span class="comment">   * socket 函数文档：https://man7.org/linux/man-pages/man2/socket.2.html</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">int</span> socket_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (socket_fd == <span class="number">-1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;failed to create socket\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 将 socket 绑定网络接口（IP + 端口）</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">  address.sin_family = AF_INET;</span><br><span class="line">  address.sin_addr.s_addr = INADDR_ANY; <span class="comment">// 相当于 0.0.0.0</span></span><br><span class="line">  address.sin_port = htons(<span class="number">8888</span>);</span><br><span class="line">  <span class="comment">// https://man7.org/linux/man-pages/man2/bind.2.html</span></span><br><span class="line">  <span class="type">int</span> code = bind(socket_fd, &amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">  <span class="keyword">if</span> (code &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;failed to bind net interface\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. 开始监听连接</span></span><br><span class="line">  <span class="comment">// 第二个参数称为 backlog，用于指定等待连接的队列长度。</span></span><br><span class="line">  <span class="comment">// listen 函数文档，https://man7.org/linux/man-pages/man2/listen.2.html</span></span><br><span class="line">  code = listen(socket_fd, <span class="number">1024</span>);</span><br><span class="line">  <span class="keyword">if</span> (code &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;failed to listen at 0.0.0.0:8888\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;listen at 0.0.0.0:8888\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. pending 队列中取出连接</span></span><br><span class="line">  <span class="comment">// https://man7.org/linux/man-pages/man2/accept.2.html</span></span><br><span class="line">  <span class="type">int</span> conn;</span><br><span class="line">  <span class="keyword">while</span> ((conn = accept(socket_fd, <span class="literal">NULL</span>, <span class="literal">NULL</span>)))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> *message = <span class="string">&quot;Hello\n&quot;</span>;</span><br><span class="line">    <span class="comment">// 向 client 发送消息</span></span><br><span class="line">    write(conn, message, <span class="built_in">strlen</span>(message));</span><br><span class="line">    <span class="comment">// 关闭链接</span></span><br><span class="line">    close(conn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(socket_fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译执行以上代码，就可以在本地建立 server 了，然后用 telnet 连接：</p>
<p><img src="/images/tcp/telnet.png" alt="telnet.png"></p>
<p>server 发送了 <code>Hello</code> 之后，关闭了链接。</p>
<p>开发 Unix 的大神们（Ken Thompson, Rob Pike 等）又开发了一个名为 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Plan_9_from_Bell_Labs">plan9</a> 的操作系统，它的网络编程更为简单，可以参考：<a target="_blank" rel="noopener" href="http://doc.cat-v.org/plan_9/4th_edition/papers/net/%E3%80%82%E5%8F%AF%E6%83%9C">http://doc.cat-v.org/plan_9/4th_edition/papers/net/。可惜</a> plan9 并没有像 Unix 一样有着革命性的影响，反而绝大多数开发者并没有听过这个系统。<br>不过令人欣慰的是 plan9 的理念被 Go 语言继承下来，并将在现在的网络开发中发挥光热。</p>
<h2 id="TCP-粘包"><a href="#TCP-粘包" class="headerlink" title="TCP 粘包"></a>TCP 粘包</h2><p>为了方便，下面的 server 只处理一条链接。实际开发中，会用多线程加 AIO 的方式并发处理多条链接。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新上文 listen 和 return 之间的代码</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> buffer_size = <span class="number">11</span>;</span><br><span class="line"><span class="type">char</span> buffer[buffer_size];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; buffer_size; i++) &#123;</span><br><span class="line">  buffer[i] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> conn = accept(socket_fd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">// 每次从链接中最多读取10个字节</span></span><br><span class="line">  <span class="type">int</span> count = read(conn, &amp;buffer, buffer_size<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;connection end&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  buffer[count] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;receive message from client:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新编译启动 server，再用 telnet 连接 server 发送 <code>hello world</code>，查看 server 的输出：</p>
<p><img src="/images/tcp/echo.png" alt="echo.png"></p>
<p>可以看到 server 端把 <code>hello world</code> 这么一条完整端消息拆成了两条来处理。</p>
<p>为什么会有这个问题呢？</p>
<p>首先 client 发送的任何数据（文本、JSON、图片、视频、音频）最终都会作为字节在网络中传递，TCP 不知道这些数据是什么，只是一串字节而已。</p>
<p>其次 server 每次只读取 10 个字节，而 client 发送的消息长度为 11 字节，所以 server 分成了两次读取并处理，第 11 个字符在第二次才读取到。</p>
<p>我们可以一次读取更多字节，比如 1024 字节。但是本质的问题并没有解决：如果 client 每次发送的消息长度都是不定的，server 要怎么从一串字节中正确的分割消息呢？</p>
<p>这也就是所谓的 TCP 粘包问题。注意：这不是 TCP 的问题，而是应用层需要处理的问题。</p>
<p>通常有这么几个思路：</p>
<ol>
<li>保证消息的长度是一致的。缺点是不够灵活。</li>
<li>用一个或几个特定字符作为消息的分隔符。缺点是对消息的编码要求比较高，而且消息的分割效率不高。</li>
<li>消息遵守特定的编码，在消息中包含消息的长度。这是目前比较广泛的做法。</li>
</ol>
<p>接下来我们按照第 3 种方法实现一个简单的消息编码规则：</p>
<ol>
<li>首字节表示消息的 code。</li>
<li>接下来的 3 个字节表示消息体的长度。这就说明消息体最多有 1&lt;&lt;24 - 1 个字节，大约 16MB。</li>
<li>后面跟着消息体。</li>
</ol>
<p>server 的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 替换上文 bind 后面的代码</span></span><br><span class="line"><span class="type">char</span> msg_hd[<span class="number">4</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> conn = accept(socket_fd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 先读取消息 code 和长度</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    msg_hd[i] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> count = read(conn, &amp;msg_hd, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> (count &lt; <span class="number">4</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;connection end: short head&quot;</span>);</span><br><span class="line">    close(conn);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;receive message from client:\n&quot;</span>);</span><br><span class="line">  <span class="type">char</span> code = msg_hd[<span class="number">0</span>];</span><br><span class="line">  <span class="type">int</span> len = msg_hd[<span class="number">1</span>] + (msg_hd[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) + (msg_hd[<span class="number">3</span>] &lt;&lt; <span class="number">16</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;code: %d, message length: %d\n&quot;</span>, code, len);</span><br><span class="line">  <span class="comment">// 读取消息体</span></span><br><span class="line">  <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> buffer[len + <span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> count = read(conn, &amp;buffer, len);</span><br><span class="line">    <span class="keyword">if</span> (count &lt; len)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;connection end: short body&quot;</span>);</span><br><span class="line">      close(conn);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    buffer[count] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;message [%s]\n&quot;</span>, buffer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于对消息进行了二进制编码，就不能直接用 telnet 来发起请求了。使用 nodejs 脚本如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = net.<span class="title function_">connect</span>(<span class="number">8888</span>, <span class="string">&#x27;localhost&#x27;</span>, <span class="function">(<span class="params">conn</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;connected to server.&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hello = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([</span><br><span class="line">  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>])),</span><br><span class="line">  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> world = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([</span><br><span class="line">  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">2</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>])),</span><br><span class="line">  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;world&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将两条消息拼接在一起发送</span></span><br><span class="line">client.<span class="title function_">write</span>(<span class="title class_">Buffer</span>.<span class="title function_">concat</span>([hello, world]));</span><br><span class="line"></span><br><span class="line"><span class="comment">// node client.js 执行脚本</span></span><br></pre></td></tr></table></figure>

<p>可以看到 server 端：</p>
<p><img src="/images/tcp/code.png" alt="code.png"></p>
<p>虽然 client 将两条消息拼接在一起发送，server 还是成功的解析了消息。</p>
<h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><p>前面的例子其实已经实现了一个简易的 RPC 系统。所有应用层的协议都是类似的原理，约定一套<strong>编码</strong>规则，然后对不同种类的消息做不同的处理。</p>
<p>同时，不要忽略的是：TCP 是全双工长链接。server 和 client 之间可以保持连接，并且有来有回的发送很多条消息，除非一方主动或者由于故障断开连接。</p>
<p>DNS、路由器、网卡、CPU 这些硬件付出了巨大的努力才建立一条链接，而 HTTP&#x2F;1.0 却只用来发送一条请求&#x2F;响应消息就断开了它，这是多么巨大的资源浪费！</p>
<p>随着万维网的发展，http 1.0 逐渐暴露了网络性能低下的缺陷，包括链接利用率太低、消息头太大，才有了后面的 http 1.1 和 http&#x2F;2。</p>
<p>我们接下来看看最简单的 http 1.x 协议是如何实现的，核心依然是消息的编码。</p>
<p>非严谨举例。请求报文格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;method&gt; &lt;url&gt; HTTP/1.1</span><br><span class="line">&lt;header-field&gt;: &lt;header-value&gt;</span><br><span class="line"></span><br><span class="line">&lt;request body&gt;</span><br></pre></td></tr></table></figure>

<p>响应报文格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 122</span><br><span class="line">&lt;header-field&gt;: &lt;header-value&gt;</span><br><span class="line"></span><br><span class="line">&lt;response body&gt;</span><br></pre></td></tr></table></figure>

<p>为了方便理解，改用 js 实现一个简单的 http server：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> delimiter = <span class="string">&#x27;\r\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = net.<span class="title function_">createServer</span>(<span class="function">(<span class="params">conn</span>) =&gt;</span> &#123;</span><br><span class="line">  conn.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> method = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">let</span> url = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">let</span> protocol = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> headers = &#123;&#125;;</span><br><span class="line">  <span class="keyword">let</span> body = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">let</span> methodParsed = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> inBody = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">sendResponse</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`method: <span class="subst">$&#123;method&#125;</span>, url: <span class="subst">$&#123;url&#125;</span>, protocol: <span class="subst">$&#123;protocol&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`headers: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(headers, <span class="literal">undefined</span>, <span class="number">2</span>)&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`body: <span class="subst">$&#123;body&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> resBody = <span class="string">`&lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;Hello HTTP&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">  &lt;h1&gt;Hello HTTP&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> res = [</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;protocol&#125;</span> 200 OK`</span>,</span><br><span class="line">      <span class="string">`Content-Type: text/html`</span>,</span><br><span class="line">      <span class="string">`Content-Length: <span class="subst">$&#123;resBody.length&#125;</span>`</span>,</span><br><span class="line">      delimiter,</span><br><span class="line">      resBody</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    conn.<span class="title function_">write</span>(res.<span class="title function_">join</span>(delimiter));</span><br><span class="line">    conn.<span class="title function_">end</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">isRequestEnd</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> body.<span class="property">length</span> &gt;= (headers[<span class="string">&#x27;Content-Length&#x27;</span>] || <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  conn.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">    data += chunk;</span><br><span class="line">    <span class="keyword">if</span> (inBody) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isRequestEnd</span>()) &#123;</span><br><span class="line">        <span class="title function_">sendResponse</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (data.<span class="title function_">substr</span>(i, <span class="number">2</span>) === delimiter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="title function_">substr</span>(i + <span class="number">2</span>, <span class="number">2</span>) === delimiter) &#123;</span><br><span class="line">          inBody = <span class="literal">true</span>;</span><br><span class="line">          data = data.<span class="title function_">slice</span>(i + <span class="number">4</span>);</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isRequestEnd</span>()) &#123;</span><br><span class="line">            <span class="title function_">sendResponse</span>();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> line = data.<span class="title function_">slice</span>(<span class="number">0</span>, i);</span><br><span class="line">        <span class="keyword">if</span> (methodParsed) &#123;</span><br><span class="line">          <span class="keyword">const</span> [key, value] = line.<span class="title function_">split</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">          headers[key] = value;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`header: <span class="subst">$&#123;key&#125;</span> <span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          [method, url, protocol] = line.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">          methodParsed = <span class="literal">true</span>;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`method: <span class="subst">$&#123;method&#125;</span>, url: <span class="subst">$&#123;url&#125;</span>, protocol: <span class="subst">$&#123;protocol&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        data = data.<span class="title function_">slice</span>(i + <span class="number">2</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure>

<p>打开浏览器访问 <code>http://localhost:8888</code> 可以看到 HTML 页面。</p>
<p>从上面的代码可以看到，HTTP 报文头部的 <code>Content-Length</code> 字段说明了请求&#x2F;响应体的字节长度，和我们前面的简单消息编码类似。</p>
<p>http 的请求体和响应体也是一串字节，但是在收到这些字节应该如何解析呢？</p>
<p>答案是由报文头部的 <code>Content-Type</code> 说明这些字节应该如何解码，常见的有 <code>application/json</code> 和 <code>multipart/form-data</code> 等。这些类型可以告诉接收方应该如何解析这些字节。</p>
<h3 id="HTTP-x2F-2"><a href="#HTTP-x2F-2" class="headerlink" title="HTTP&#x2F;2"></a>HTTP&#x2F;2</h3><p><a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/performance/http2?hl=zh-cn">HTTP&#x2F;2</a> 于 2015 年发布，主要是基于 Google 的 SPDY 协议。</p>
<p>针对 HTTP 1.x 的改进如下：</p>
<ol>
<li>二进制传输。包体积更小，效率更高。</li>
<li>多路复用。同一条 TCP 链接可以处理多个请求响应。</li>
<li>Header 压缩。减少每次请求的 header 大小，提高带宽利用率。</li>
</ol>
<p>可以看到，HTTP&#x2F;2 的以上特点都是针对 HTTP 1.x 的缺点进行的改进。在理解了 TCP 的原理之后，我们能更容易的理解这些改进，因为从一个高效的通信系统的角度来看，HTTP 1.x 的缺点实在太明显了。</p>
<h3 id="HTTP-x2F-3"><a href="#HTTP-x2F-3" class="headerlink" title="HTTP&#x2F;3"></a>HTTP&#x2F;3</h3><p>HTTP&#x2F;3 主要是基于 Google 的 <a target="_blank" rel="noopener" href="https://www.chromium.org/quic">Quic</a> 协议，将底层的 TCP 换成了 UDP。</p>
<p>原因是 TCP 为了保证可靠传输，在性能上做了很多妥协，比如每一个数据包的 ACK。而 socket 都被集成到了各大操作系统的内核，内核的更新是比较慢的。</p>
<p>而且由于现在的网络稳定性和带宽相比 20 年前有了很大的改善，Google 决定在 UDP 的基础上增加安全性校验和可靠性算法，推出了 Quic 协议，目的是兼具高效和可靠。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yinjun.github.io/2022/04/19/tcp/" data-id="cl2ef05lo000a8mmtbojpez6j" data-title="从 TCP 说起" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/04/19/passive_touch/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          Unable to preventDefault inside passive event listener
        
      </div>
    </a>
  
  
    <a href="/2022/04/19/vite/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">vite 为什么快</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/chrome-extensions/" rel="tag">chrome,extensions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/event-passive/" rel="tag">event,passive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/forever/" rel="tag">forever</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js-this/" rel="tag">js,this</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/json-schema/" rel="tag">json,schema</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/viewport/" rel="tag">viewport</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vitejs-vite/" rel="tag">vitejs,vite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/chrome-extensions/" style="font-size: 10px;">chrome,extensions</a> <a href="/tags/event-passive/" style="font-size: 10px;">event,passive</a> <a href="/tags/forever/" style="font-size: 10px;">forever</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/js-this/" style="font-size: 10px;">js,this</a> <a href="/tags/json-schema/" style="font-size: 10px;">json,schema</a> <a href="/tags/tcp/" style="font-size: 10px;">tcp</a> <a href="/tags/viewport/" style="font-size: 10px;">viewport</a> <a href="/tags/vitejs-vite/" style="font-size: 10px;">vitejs,vite</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/04/19/articles/">好文集锦</a>
          </li>
        
          <li>
            <a href="/2022/04/19/chrome_extension/">chrome 插件开发入门</a>
          </li>
        
          <li>
            <a href="/2022/04/19/design_patterns/">设计模式</a>
          </li>
        
          <li>
            <a href="/2022/04/19/forever/">后台运行 NodeJS</a>
          </li>
        
          <li>
            <a href="/2022/04/19/git/">git 常用命令</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 yinjun<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>